<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Management - Exam Detail</title>
    <link rel="stylesheet" href="../static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/axios@latest/dist/axios.min.js"></script>
    <style>
        .btn-add-option {
            margin-top: 10px;
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-add-option:hover {
            background: #2563eb;
        }
        .btn-remove-option {
            margin-left: 8px;
            padding: 4px 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }
        .btn-remove-option:hover {
            background: #dc2626;
        }
        .error-message {
            color: #ef4444;
            font-size: 13px;
            margin-top: 4px;
            display: none;
            font-weight: 500;
        }
        .error-message.show {
            display: block;
        }
        .form-group input.error,
        .form-group textarea.error {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
        }
        .option-input-row input.error {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
        }
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }

        .submit-badge.pending {
            background-color: #fef3c7;
            color: #d97706;
        }

        .submit-badge.graded {
            background-color: #d1fae5;
            color: #059669;
        }

        .student-avatar.blue {
            background-color: #3b82f6;
        }

        .student-avatar.green {
            background-color: #10b981;
        }

        .student-avatar.purple {
            background-color: #8b5cf6;
        }

        .student-avatar.orange {
            background-color: #f97316;
        }

        .student-avatar.pink {
            background-color: #ec4899;
        }

        .student-avatar.teal {
            background-color: #14b8a6;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Exam Management</h1>
                <p>Teacher Dashboard</p>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/examManagement" class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M9 9h6M9 13h6M9 17h4"/>
                    </svg>
                    Examinations
                </a>
                <a href="#" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Students
                </a>
                <a href="#" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                        <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                    </svg>
                    Reports
                </a>
                <a href="#" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Settings
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-avatar">T</div>
                <div class="user-info">
                    <h4>Teacher</h4>
                    <p>teacher@school.edu</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header with Back Button -->
            <div class="exam-header">
                <div class="exam-header-left">
                    <a href="/examManagement" class="back-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                    </a>
                    <div class="exam-title-section">
                        <div class="exam-title-row">
                            <h2 class="exam-title" id="examTitle">Loading...</h2>
                            <span class="status-badge status-ongoing" id="examStatusBadge">Ongoing</span>
                        </div>
                        <p class="exam-subtitle">View and manage exam questions and submissions</p>
                    </div>
                </div>
                <button class="btn-edit-exam">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    Edit Exam
                </button>
            </div>

            <!-- Exam Info Cards -->
            <div class="exam-info-cards" id="examInfoCards"></div>

            <!-- Tabs -->
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('assigned-questions', this)">Assigned Questions</button>
                    <button class="tab" onclick="switchTab('student-submissions', this)">Student Submissions</button>
                </div>
            </div>

            <!-- Tab Content: Assigned Questions -->
            <div class="tab-content active" id="assigned-questions">
                <div class="question-stats" id="questionStats"></div>
                <div class="questions-list" id="questionsList"></div>
            </div>

            <!-- Tab Content: Student Submissions -->
            <div class="tab-content" id="student-submissions">
                <div class="submission-stats" id="submissionStats"></div>
                <div class="submission-filters">
                    <div class="search-box submission-search">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <input type="text" id="submissionSearch" placeholder="Search by name, ID, or email..." onkeyup="filterSubmissions()">
                    </div>
                    <div class="filter-tabs" id="filterTabs"></div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>STUDENT ID</th>
                                <th>STUDENT NAME</th>
                                <th>SUBMIT STATUS</th>
                                <th>SUBMISSION DATE</th>
                                <th>SCORE</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="submissionsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit MCQ Modal -->
    <div class="modal-overlay" id="mcqModal">
        <div class="modal modal-question">
            <div class="modal-header-new">
                <div class="modal-header-left">
                    <div class="modal-icon blue">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <path d="M9 9h6M9 13h6M9 17h4"/>
                        </svg>
                    </div>
                    <div class="modal-title-group">
                        <h3 id="mcqModalTitle">Add MCQ Question</h3>
                        <p>Create a multiple choice question</p>
                    </div>
                </div>
                <button class="modal-close-btn" onclick="closeAllModals()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="mcqForm" onsubmit="saveMCQ(event)" novalidate>
                    <input type="hidden" id="mcqEditId" value="">
                    
                    <div class="form-group">
                        <label>Question <span class="required">*</span></label>
                        <textarea style="resize: none;" id="mcqQuestion" placeholder="Enter your question here..." rows="3" oninput="clearError('mcqQuestion')"></textarea>
                        <div class="error-message" id="mcqQuestionError">Question text is required</div>
                    </div>

                    <div class="form-group">
                        <label>Answer Options <span class="required">*</span></label>
                        <div class="options-input-list" id="mcqOptionsList">
                            <!-- Options will be rendered dynamically -->
                        </div>
                        <div class="error-message" id="mcqOptionsError">At least 2 options are required and all options must be filled</div>
                        <button type="button" class="btn-add-option" onclick="addOption()">+ Add Option</button>
                        <p class="form-hint">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            Click the circle to mark the correct answer. Minimum 2 options required.
                        </p>
                    </div>

                    <div class="form-group">
                        <label>Points <span class="required">*</span></label>
                        <input type="number" id="mcqPoints" value="5" min="1" oninput="clearError('mcqPoints')">
                        <div class="error-message" id="mcqPointsError">Points must be a positive number greater than 0</div>
                    </div>

                    <div class="modal-footer-new">
                        <button type="submit" class="btn-modal-submit blue" id="mcqSubmitBtn">Add Question</button>
                        <button type="button" class="btn-modal-cancel" onclick="closeAllModals()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Essay Modal -->
    <div class="modal-overlay" id="essayModal">
        <div class="modal modal-question">
            <div class="modal-header-new">
                <div class="modal-header-left">
                    <div class="modal-icon purple">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                    </div>
                    <div class="modal-title-group">
                        <h3 id="essayModalTitle">Add Essay Question</h3>
                        <p>Create an essay question</p>
                    </div>
                </div>
                <button class="modal-close-btn" onclick="closeAllModals()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="essayForm" onsubmit="saveEssay(event)" novalidate>
                    <input type="hidden" id="essayEditId" value="">

                    <div class="form-group">
                        <label>Question <span class="required">*</span></label>
                        <textarea style="resize: none;" id="essayQuestion" placeholder="Enter your essay question here..." rows="4" oninput="clearError('essayQuestion')"></textarea>
                        <div class="error-message" id="essayQuestionError">Question text is required</div>
                    </div>

                    <div class="form-group">
                        <label>Points <span class="required">*</span></label>
                        <input type="number" id="essayPoints" value="20" min="1" oninput="clearError('essayPoints')">
                        <div class="error-message" id="essayPointsError">Points must be a positive number greater than 0</div>
                    </div>

                    <div class="form-group">
                        <label>Grading Rubric <span class="required">*</span></label>
                        <textarea style="resize: none;" id="essayRubric" placeholder="e.g., Content relevance (40%), Critical thinking (30%), Examples (20%), Writing quality (10%)" rows="2" oninput="clearError('essayRubric')"></textarea>
                        <div class="error-message" id="essayRubricError">Grading rubric is required</div>
                    </div>

                    <div class="form-group">
                        <label>Reference Answer (Optional)</label>
                        <textarea style="resize: none;" id="essayReferenceAnswer" placeholder="Enter a reference answer or key points..." rows="3"></textarea>
                    </div>

                    <div class="modal-footer-new">
                        <button type="submit" class="btn-modal-submit purple" id="essaySubmitBtn">Add Question</button>
                        <button type="button" class="btn-modal-cancel" onclick="closeAllModals()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('id');
        
        let currentExam = null;
        let currentFilter = 'all';
        let selectedCorrectAnswer = 0;
        let mcqOptionsCount = 4;

        // Validation helper functions
        function showError(fieldId, message) {
            const errorElement = document.getElementById(fieldId + 'Error');
            const inputElement = document.getElementById(fieldId);
            
            if (errorElement) {
                errorElement.textContent = message || errorElement.textContent;
                errorElement.classList.add('show');
            }
            if (inputElement) {
                inputElement.classList.add('error');
            }
        }

        function clearError(fieldId) {
            const errorElement = document.getElementById(fieldId + 'Error');
            const inputElement = document.getElementById(fieldId);
            
            if (errorElement) {
                errorElement.classList.remove('show');
            }
            if (inputElement) {
                inputElement.classList.remove('error');
            }
            
            // Clear errors from option inputs
            document.querySelectorAll('.option-input-row input').forEach(input => {
                input.classList.remove('error');
            });
        }

        function clearAllErrors() {
            document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
        }

        function validateMCQForm() {
            clearAllErrors();
            let isValid = true;

            // Validate question text
            const question = document.getElementById('mcqQuestion').value.trim();
            if (!question) {
                showError('mcqQuestion', 'Question text is required');
                isValid = false;
            }

            // Validate options
            const options = [];
            let hasEmptyOption = false;
            
            for (let i = 0; i < mcqOptionsCount; i++) {
                const optionInput = document.getElementById(`mcqOption${i + 1}`);
                if (optionInput) {
                    const optionValue = optionInput.value.trim();
                    if (!optionValue) {
                        hasEmptyOption = true;
                        optionInput.classList.add('error');
                    } else {
                        options.push(optionValue);
                    }
                }
            }

            // Check minimum options
            if (mcqOptionsCount < 2) {
                showError('mcqOptions', 'At least 2 options are required');
                isValid = false;
            } else if (hasEmptyOption) {
                showError('mcqOptions', 'All option fields must be filled');
                isValid = false;
            }

            // Validate points
            const points = parseInt(document.getElementById('mcqPoints').value);
            if (!points || points <= 0) {
                showError('mcqPoints', 'Points must be a positive number greater than 0');
                isValid = false;
            }

            return isValid;
        }

        function validateEssayForm() {
            clearAllErrors();
            let isValid = true;

            // Validate question text
            const question = document.getElementById('essayQuestion').value.trim();
            if (!question) {
                showError('essayQuestion', 'Question text is required');
                isValid = false;
            }

            // Validate points
            const points = parseInt(document.getElementById('essayPoints').value);
            if (!points || points <= 0) {
                showError('essayPoints', 'Points must be a positive number greater than 0');
                isValid = false;
            }

            // Validate rubric
            const rubric = document.getElementById('essayRubric').value.trim();
            if (!rubric) {
                showError('essayRubric', 'Grading rubric is required');
                isValid = false;
            }

            return isValid;
        }

        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => successDiv.remove(), 300);
            }, 3000);
        }

        async function loadExamData() {
            try {
                console.log('Fetching exam with ID:', examId);
                
                // Verify exam ID exists
                const examResponse = await axios.get(`/exams/${examId}`);
                const exam = examResponse.data;
                
                if (!exam) {
                    throw new Error('Exam ID does not exist');
                }
                
                const questionsResponse = await axios.get(`/questions/exam/${examId}`);
                const questions = questionsResponse.data;

                // Try to get submissions, but don't fail if it doesn't work
                let submissions = [];
                try {
                    const submissionsResponse = await axios.get(`/submissions/exam/${examId}/students`);
                    submissions = submissionsResponse.data || [];
                    console.log('Submissions data:', submissions);
                } catch (submissionError) {
                    console.warn('Could not load submissions:', submissionError);
                    // Continue without submissions data
                }
                
                console.log('Exam data:', exam);
                console.log('Questions data:', questions);
                
                currentExam = transformExamData(exam);
                currentExam.questions = transformQuestions(questions);
                currentExam.submissions = transformSubmissions(submissions);

               currentExam.totalStudents = submissions.length;
               currentExam.submitted = submissions.filter(s => s.status === 'pending' || s.status === 'graded').length;
               currentExam.missed = submissions.filter(s => s.status === 'missed').length;

                renderExamInfo();
                renderQuestionStats();
                renderQuestions();
                renderSubmissionStats();
                renderFilterTabs();
                renderSubmissions();
                
            } catch (error) {
                console.error('Error loading exam:', error);
                if (error.response?.status === 404) {
                    alert('Error: The exam ID does not exist. Please check the exam ID and try again.');
                } else {
                    alert('Failed to load exam details: ' + (error.response?.data?.detail || error.message));
                }
                window.location.href = '/examManagement';
            }
        }


        function transformExamData(exam) {

            const examDate = exam.date;
            const startTimeStr = exam.start_time;
            const endTimeStr = exam.end_time;
            
            const startTime = startTimeStr.slice(0, 5);
            const endTime = endTimeStr.slice(0, 5);
            
            return {
                id: exam.id,
                examId: exam.exam_code || `EXAM${exam.id}`,
                title: exam.title,
                date: examDate,
                startTime: startTime,
                endTime: endTime,
                duration: exam.duration + ' min',
                status: exam.status || 'scheduled',
                totalStudents: 0,
                submitted: 0,
                missed: 0,
                questions: [],
                submissions: []
            };
        }

        function transformQuestions(questions) {
            return questions.map(q => {
                if (q.question_type === 'mcq') {
                    return {
                        id: q.id,
                        type: 'mcq',
                        question: q.question_text,
                        points: q.marks,
                        options: q.options.map(opt => opt.option_text),
                        correctAnswer: q.options.findIndex(opt => opt.is_correct)
                    };
                } else {
                    return {
                        id: q.id,
                        type: 'essay',
                        question: q.question_text,
                        points: q.marks,
                        rubric: q.rubric,
                        referenceAnswer: q.reference_answer
                    };
                }
            });
        }

       function transformSubmissions(submissions) {
        return submissions.map(sub => {
            // Generate avatar from name
            const name = sub.student_name || sub.student_email;
            const nameParts = name.split(' ');
            const avatar = nameParts.length > 1 
                ? nameParts[0][0].toUpperCase() + nameParts[1][0].toUpperCase()
                : name.substring(0, 2).toUpperCase();
            
            // Avatar colors - use modulo to cycle through colors
            const colors = ['blue', 'green', 'purple', 'orange', 'pink', 'teal'];
            const colorIndex = Math.abs(sub.student_id) % colors.length;
            const avatarColor = colors[colorIndex];
            
            // Calculate percentage if score exists
            let percentage = '';
            if (sub.score !== null && sub.score !== undefined) {
                const totalPoints = currentExam?.questions.reduce((sum, q) => sum + q.points, 0) || 100;
                const percent = Math.round((sub.score / totalPoints) * 100);
                percentage = `${percent}%`;
            }
            
            // Format time to show only HH:MM
            let formattedTime = null;
            if (sub.submission_time) {
                formattedTime = sub.submission_time.substring(0, 5); // Gets HH:MM from HH:MM:SS
            }
            
            return {
                id: sub.submission_id,
                studentId: `STU${String(sub.student_id).padStart(4, '0')}`,
                studentName: sub.student_name || sub.student_email,
                studentEmail: sub.student_email,
                avatar: avatar,
                avatarColor: avatarColor,
                status: sub.status,
                submissionDate: sub.submission_date 
                    ? formatDate(sub.submission_date)
                    : null,
                submissionTime: formattedTime,
                score: sub.score,
                scoreGrade: sub.score_grade,
                percentage: percentage,
                feedback: sub.overall_feedback
            };
        });
        }
        function formatDate(dateStr) {
        // Format date from YYYY-MM-DD to readable format
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const day = date.getDate();
            const month = date.toLocaleString('en-US', { month: 'short' });
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        function init() {
            if (!examId) {
                alert('Error: No exam ID provided. Please select a valid exam.');
                window.location.href = '/examManagement';
                return;
            }
            loadExamData();
        }

        function renderExamInfo() {
            if (!currentExam) return;
            document.getElementById('examTitle').textContent = currentExam.title;
            document.getElementById('examStatusBadge').textContent = currentExam.status.charAt(0).toUpperCase() + currentExam.status.slice(1);
            document.getElementById('examStatusBadge').className = `status-badge status-${currentExam.status}`;
            document.getElementById('examInfoCards').innerHTML = `
                <div class="info-card"><span class="info-label">Exam ID</span><span class="info-value">${currentExam.examId}</span></div>
                <div class="info-card"><span class="info-label">Date</span><span class="info-value">${currentExam.date}</span></div>
                <div class="info-card"><span class="info-label">Time</span><span class="info-value">${currentExam.startTime} - ${currentExam.endTime}</span></div>
                <div class="info-card"><span class="info-label">Duration</span><span class="info-value">${currentExam.duration}</span></div>
            `;
        }

        function renderQuestionStats() {
            if (!currentExam) return;
            const mcqCount = currentExam.questions.filter(q => q.type === 'mcq').length;
            const essayCount = currentExam.questions.filter(q => q.type === 'essay').length;
            const totalPoints = currentExam.questions.reduce((sum, q) => sum + q.points, 0);
            document.getElementById('questionStats').innerHTML = `
                <div class="stat-item"><span class="stat-dot blue"></span><span>MCQ Questions: <strong>${mcqCount}</strong></span></div>
                <div class="stat-item"><span class="stat-dot purple"></span><span>Essay Questions: <strong>${essayCount}</strong></span></div>
                <div class="stat-item"><svg viewBox="0 0 24 24" fill="#fbbf24" stroke="#fbbf24" stroke-width="2" width="16" height="16"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg><span>Total Points: <strong>${totalPoints}</strong></span></div>
                <div class="add-question-dropdown">
                    <button class="btn-add-question" onclick="toggleDropdown(event)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Question
                        <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                    </button>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="#" class="dropdown-item" onclick="openMCQModal(event)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>
                            <div><span class="dropdown-title">Add MCQ</span><span class="dropdown-desc">Multiple choice question</span></div>
                        </a>
                        <a href="#" class="dropdown-item" onclick="openEssayModal(event)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            <div><span class="dropdown-title">Add Essay</span><span class="dropdown-desc">Essay question</span></div>
                        </a>
                    </div>
                </div>
            `;
        }

        function renderQuestions() {
            if (!currentExam) return;
            const container = document.getElementById('questionsList');
            
            const isCompleted = currentExam.status === 'completed';
            
            if (currentExam.questions.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:#6c757d;">No questions added yet</div>';
                return;
            }
            
            container.innerHTML = currentExam.questions.map((q, index) => {
                const editButton = isCompleted 
                    ? '' 
                    : `<button class="action-btn edit" onclick="editQuestion(${q.id}, '${q.type}')" title="Edit"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>`;
                
                if (q.type === 'mcq') {
                    return `<div class="question-card">
                        <div class="question-header">
                            <div class="question-number">${index + 1}</div>
                            <span class="question-type mcq">MCQ</span>
                            <span class="question-points">${q.points} points</span>
                            <div class="question-actions">
                                ${editButton}
                                <button class="action-btn delete" onclick="deleteQuestion(${q.id})" title="Delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                            </div>
                        </div>
                        <div class="question-content">
                            <p class="question-text">${q.question}</p>
                            <div class="options-list">
                                ${q.options.map((opt, i) => `<div class="option ${i === q.correctAnswer ? 'correct' : ''}"><span class="option-radio ${i === q.correctAnswer ? 'checked' : ''}">${i === q.correctAnswer ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}</span><span>${opt}</span></div>`).join('')}
                            </div>
                        </div>
                    </div>`;
                } else {
                    return `<div class="question-card">
                        <div class="question-header">
                            <div class="question-number">${index + 1}</div>
                            <span class="question-type essay">Essay</span>
                            <span class="question-points">${q.points} points</span>
                            <div class="question-actions">
                                ${editButton}
                                <button class="action-btn delete" onclick="deleteQuestion(${q.id})" title="Delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                            </div>
                        </div>
                        <div class="question-content">
                            <p class="question-text">${q.question}</p>
                            ${q.rubric ? `<div class="rubric-box"><div class="rubric-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span>Rubric</span></div><p class="rubric-text">${q.rubric}</p></div>` : ''}
                        </div>
                    </div>`;
                }
            }).join('');
        }

        function renderSubmissionStats() {
            if (!currentExam) return;
            const totalStudents = currentExam.totalStudents || 0;
            const submitted = currentExam.submitted || 0;
            const missed = currentExam.missed || 0;
            
            document.getElementById('submissionStats').innerHTML = `
                <div class="stat-card blue"><div class="stat-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div><div class="stat-content"><span class="stat-number">${totalStudents}</span><span class="stat-label">Total Students</span></div></div>
                <div class="stat-card green"><div class="stat-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div><div class="stat-content"><span class="stat-number">${submitted}</span><span class="stat-label">Submitted</span></div></div>
                <div class="stat-card red"><div class="stat-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></div><div class="stat-content"><span class="stat-number">${missed}</span><span class="stat-label">Missed</span></div></div>
            `;
        }


       function renderFilterTabs() {
            if (!currentExam) return;
            const submissions = currentExam.submissions || [];
            const pending = submissions.filter(s => s.status === 'pending').length;
            const graded = submissions.filter(s => s.status === 'graded').length;
            const missed = submissions.filter(s => s.status === 'missed').length;
            
            document.getElementById('filterTabs').innerHTML = `
                <button class="filter-tab ${currentFilter === 'all' ? 'active' : ''}" onclick="setFilter('all')">All (${submissions.length})</button>
                <button class="filter-tab ${currentFilter === 'pending' ? 'active' : ''}" onclick="setFilter('pending')">Pending (${pending})</button>
                <button class="filter-tab ${currentFilter === 'graded' ? 'active' : ''}" onclick="setFilter('graded')">Graded (${graded})</button>
                <button class="filter-tab ${currentFilter === 'missed' ? 'active' : ''}" onclick="setFilter('missed')">Missed (${missed})</button>
            `;
        }

        function renderSubmissions() {
            if (!currentExam) return;
            
            const submissions = currentExam.submissions || [];
            const search = document.getElementById('submissionSearch')?.value.toLowerCase() || '';
            let filtered = submissions;
            
            // Filter by status
            if (currentFilter !== 'all') {
                filtered = filtered.filter(s => s.status === currentFilter);
            }
            
            // Filter by search
            if (search) {
                filtered = filtered.filter(s => 
                    s.studentName.toLowerCase().includes(search) || 
                    s.studentId.toLowerCase().includes(search) || 
                    s.studentEmail.toLowerCase().includes(search)
                );
            }
            
            const tbody = document.getElementById('submissionsTableBody');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#6c757d;">No submissions found</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(s => {
                // Format score display
                let scoreDisplay = '-';
                if (s.score !== null && s.score !== undefined) {
                    scoreDisplay = `${s.score}`;
                    if (s.percentage) {
                        scoreDisplay += ` <span style="color:#6c757d;">(${s.percentage})</span>`;
                    }
                    if (s.scoreGrade) {
                        scoreDisplay += ` <span style="color:#10b981;font-weight:600;">${s.scoreGrade}</span>`;
                    }
                }
                
                // Format submission date/time
                let submissionDateTime = '-';
                if (s.submissionDate) {
                    submissionDateTime = s.submissionDate;
                    if (s.submissionTime) {
                        submissionDateTime += ` ${s.submissionTime}`;
                    }
                }
                
                // Action button - only show for submitted/pending students
                let actionButton = '-';
                
                // Only allow grading if there's an actual submission (submission_id exists)
                if (s.id && (s.status === 'submitted' || s.status === 'pending' || s.status === 'graded')) {
                    if (s.status === 'graded' || (s.scoreGrade && s.scoreGrade !== 'Pending')) {
                        // Already graded - show view button
                        actionButton = `
                            <button class="btn-grade" onclick="goToGrading(${s.id})">
                                <svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'>
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                View
                            </button>
                        `;
                    } else {
                        // Not graded yet - show grade button
                        actionButton = `
                            <button class="btn-grade" onclick="goToGrading(${s.id})">
                                <svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'>
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                                Grade
                            </button>
                        `;
                    }
                }
                // For missed submissions (no submission_id), don't show any action button
                
                return `
                    <tr>
                        <td>${s.studentId}</td>
                        <td>
                            <div class="student-info">
                                <div class="student-avatar ${s.avatarColor}">${s.avatar}</div>
                                <div class="student-details">
                                    <span class="student-name">${s.studentName}</span>
                                    <span class="student-email">${s.studentEmail}</span>
                                </div>
                            </div>
                        </td>
                        <td><span class="submit-badge ${s.status}">${s.status.charAt(0).toUpperCase() + s.status.slice(1)}</span></td>
                        <td>${submissionDateTime}</td>
                        <td>${scoreDisplay}</td>
                        <td>${actionButton}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        function setFilter(filter) {
            currentFilter = filter;
            renderFilterTabs();
            renderSubmissions();
        }

        function filterSubmissions() {
            renderSubmissions();
        }

        function toggleDropdown(e) {
            e.stopPropagation();
            const menu = document.getElementById('dropdownMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        document.addEventListener('click', () => {
            const menu = document.getElementById('dropdownMenu');
            if (menu) menu.style.display = 'none';
        });

        function selectCorrectAnswer(index) {
            selectedCorrectAnswer = index;
            document.querySelectorAll('.option-select-btn').forEach((btn, i) => {
                btn.classList.toggle('selected', i === index);
                btn.innerHTML = i === index ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : '';
            });
        }

        function renderMCQOptions(count, editData = null) {
            const container = document.getElementById('mcqOptionsList');
            container.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const isSelected = editData ? (i === editData.correctAnswer) : (i === selectedCorrectAnswer);
                const optionValue = editData && editData.options[i] ? editData.options[i] : '';
                
                const row = document.createElement('div');
                row.className = 'option-input-row';
                row.innerHTML = `
                    <button type="button" class="option-select-btn ${isSelected ? 'selected' : ''}" data-option="${i}" onclick="selectCorrectAnswer(${i})">
                        ${isSelected ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
                    </button>
                    <input type="text" id="mcqOption${i + 1}" placeholder="Option ${i + 1}" value="${optionValue}" oninput="clearError('mcqOptions')">
                    ${count > 2 ? `<button type="button" class="btn-remove-option" onclick="removeOption(${i})" title="Remove option">Ã—</button>` : ''}
                `;
                container.appendChild(row);
            }
            
            mcqOptionsCount = count;
            if (editData) {
                selectedCorrectAnswer = editData.correctAnswer;
            }
        }

        function addOption() {
            if (mcqOptionsCount >= 10) {
                alert('Maximum 10 options allowed');
                return;
            }
            mcqOptionsCount++;
            renderMCQOptions(mcqOptionsCount);
        }

        function removeOption(index) {
            if (mcqOptionsCount <= 2) {
                alert('Minimum 2 options required');
                return;
            }
            
            const currentValues = [];
            for (let i = 0; i < mcqOptionsCount; i++) {
                const input = document.getElementById(`mcqOption${i + 1}`);
                if (input && i !== index) {
                    currentValues.push(input.value);
                }
            }
            
            if (selectedCorrectAnswer === index) {
                selectedCorrectAnswer = 0;
            } else if (selectedCorrectAnswer > index) {
                selectedCorrectAnswer--;
            }
            
            mcqOptionsCount--;
            renderMCQOptions(mcqOptionsCount);
            
            currentValues.forEach((val, i) => {
                const input = document.getElementById(`mcqOption${i + 1}`);
                if (input) input.value = val;
            });
        }

        function resetMCQForm() {
            document.getElementById('mcqEditId').value = '';
            document.getElementById('mcqQuestion').value = '';
            document.getElementById('mcqPoints').value = '5';
            selectedCorrectAnswer = 0;
            mcqOptionsCount = 4;
            renderMCQOptions(4);
            clearAllErrors();
        }

        function resetEssayForm() {
            document.getElementById('essayEditId').value = '';
            document.getElementById('essayQuestion').value = '';
            document.getElementById('essayPoints').value = '20';
            document.getElementById('essayRubric').value = '';
            document.getElementById('essayReferenceAnswer').value = '';
            clearAllErrors();
        }

        function openMCQModal(e) {
            if (e) e.preventDefault();
            resetMCQForm();
            document.getElementById('mcqModalTitle').textContent = 'Add MCQ Question';
            document.querySelector('#mcqModal .modal-title-group p').textContent = 'Create a multiple choice question';
            document.getElementById('mcqSubmitBtn').textContent = 'Add Question';
            document.getElementById('mcqModal').classList.add('active');
        }

        function openEssayModal(e) {
            if (e) e.preventDefault();
            resetEssayForm();
            document.getElementById('essayModalTitle').textContent = 'Add Essay Question';
            document.querySelector('#essayModal .modal-title-group p').textContent = 'Create an essay question';
            document.getElementById('essaySubmitBtn').textContent = 'Add Question';
            document.getElementById('essayModal').classList.add('active');
        }

        async function editQuestion(id, type) {
            if (currentExam.status === 'completed') {
                alert('Cannot edit questions for completed exams');
                return;
            }
            
            try {
                const response = await axios.get(`/questions/${id}`);
                const question = response.data;
                
                if (type === 'mcq') {
                    document.getElementById('mcqEditId').value = id;
                    document.getElementById('mcqQuestion').value = question.question_text;
                    document.getElementById('mcqPoints').value = question.marks;
                    
                    const correctIndex = question.options.findIndex(opt => opt.is_correct);
                    const optionsData = {
                        options: question.options.map(opt => opt.option_text),
                        correctAnswer: correctIndex
                    };
                    
                    renderMCQOptions(question.options.length, optionsData);
                    
                    document.getElementById('mcqModalTitle').textContent = 'Edit MCQ Question';
                    document.querySelector('#mcqModal .modal-title-group p').textContent = 'Update multiple choice question';
                    document.getElementById('mcqSubmitBtn').textContent = 'Update Question';
                    document.getElementById('mcqModal').classList.add('active');
                } else {
                    document.getElementById('essayEditId').value = id;
                    document.getElementById('essayQuestion').value = question.question_text;
                    document.getElementById('essayPoints').value = question.marks;
                    document.getElementById('essayRubric').value = question.rubric || '';
                    document.getElementById('essayReferenceAnswer').value = question.reference_answer || '';
                    
                    document.getElementById('essayModalTitle').textContent = 'Edit Essay Question';
                    document.querySelector('#essayModal .modal-title-group p').textContent = 'Update essay question';
                    document.getElementById('essaySubmitBtn').textContent = 'Update Question';
                    document.getElementById('essayModal').classList.add('active');
                }
            } catch (error) {
                console.error('Error loading question:', error);
                alert('Failed to load question: ' + (error.response?.data?.detail || error.message));
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            clearAllErrors();
        }

        async function saveMCQ(e) {
            e.preventDefault();
            
            // Validate form
            if (!validateMCQForm()) {
                return;
            }
            
            const editId = document.getElementById('mcqEditId').value;
            const options = [];
            
            for (let i = 0; i < mcqOptionsCount; i++) {
                const optionInput = document.getElementById(`mcqOption${i + 1}`);
                if (optionInput && optionInput.value.trim()) {
                    options.push(optionInput.value.trim());
                }
            }
            
            const questionData = {
                exam_id: parseInt(examId),
                question_text: document.getElementById('mcqQuestion').value.trim(),
                marks: parseInt(document.getElementById('mcqPoints').value),
                options: options,
                correct_option_index: selectedCorrectAnswer
            };
            
            try {
                if (editId) {
                    await axios.put(`/questions/mcq/${editId}`, questionData);
                    showSuccessMessage('MCQ Question updated successfully!');
                } else {
                    await axios.post('/questions/mcq', questionData);
                    showSuccessMessage('MCQ Question added successfully!');
                }
                
                await loadExamData();
                closeAllModals();
                
            } catch (error) {
                console.error('Error saving question:', error);
                const errorMsg = error.response?.data?.detail || error.message;
                alert('Failed to save question: ' + errorMsg);
            }
        }

        async function saveEssay(e) {
            e.preventDefault();
            
            // Validate form
            if (!validateEssayForm()) {
                return;
            }
            
            const editId = document.getElementById('essayEditId').value;
            
            const questionData = {
                exam_id: parseInt(examId),
                question_text: document.getElementById('essayQuestion').value.trim(),
                marks: parseInt(document.getElementById('essayPoints').value),
                rubric: document.getElementById('essayRubric').value.trim() || null,
                word_limit: null,
                reference_answer: document.getElementById('essayReferenceAnswer').value.trim() || null
            };
            
            try {
                if (editId) {
                    await axios.put(`/questions/essay/${editId}`, questionData);
                    showSuccessMessage('Essay Question updated successfully!');
                } else {
                    await axios.post('/questions/essay', questionData);
                    showSuccessMessage('Essay Question added successfully!');
                }
                
                await loadExamData();
                closeAllModals();
                
            } catch (error) {
                console.error('Error saving question:', error);
                const errorMsg = error.response?.data?.detail || error.message;
                alert('Failed to save question: ' + errorMsg);
            }
        }

        async function deleteQuestion(id) {
            if (!confirm('Are you sure you want to delete this question?')) {
                return;
            }
            
            try {
                await axios.delete(`/questions/${id}`);
                showSuccessMessage('Question deleted successfully!');
                await loadExamData();
                
            } catch (error) {
                console.error('Error deleting question:', error);
                alert('Failed to delete question: ' + (error.response?.data?.detail || error.message));
            }
        }

        function goToGrading(submissionId) {
            if (!submissionId) {
                alert("Submission not found");
                return;
            }
            window.location.href = `/examGrading?submissionId=${submissionId}&examId=${examId}`;
        }

        init();
    </script>
</body>
</html>