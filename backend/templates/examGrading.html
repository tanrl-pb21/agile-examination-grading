<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Submission - Exam Management</title>
    <link rel="stylesheet" href="../static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/axios@latest/dist/axios.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Sidebar (same as before) -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Exam Management</h1>
                <p>Teacher Dashboard</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/examManagement" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M9 9h6M9 13h6M9 17h4"/>
                    </svg>
                    Examinations
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="grading-header">
                <div class="grading-header-left">
                    <a href="#" class="back-link" onclick="goBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 18l-6-6 6-6"/>
                        </svg>
                        Back to Submissions
                    </a>
                    <div class="grading-title-section">
                        <h2 class="grading-title">Grade Submission</h2>
                        <p class="grading-subtitle" id="submissionIdDisplay">Loading...</p>
                    </div>
                </div>
                <button class="btn-primary" onclick="openSaveGradesModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                    Save Grades
                </button>
            </div>

            <!-- Two Column Layout -->
            <div class="grading-layout">
                <!-- Left Column: Student & Exam Info -->
                <div class="grading-left-column">
                    <!-- Student Information Card -->
                    <div class="info-section-card">
                        <h3 class="info-section-title">Student Information</h3>
                        <div class="student-info-large">
                            <div class="student-avatar-large blue" id="studentAvatarLarge">...</div>
                            <div class="student-details-large">
                                <h4 class="student-name-large" id="studentName">Loading...</h4>
                                <p class="student-id-large" id="studentEmailDisplay">...</p>
                            </div>
                        </div>
                        <div class="info-row">
                            <span class="info-row-label">Submitted At</span>
                            <span class="info-row-value" id="submittedAt">...</span>
                        </div>
                    </div>

                    <!-- Exam Information Card -->
                    <div class="info-section-card">
                        <h3 class="info-section-title">Exam Information</h3>
                        <div class="info-row">
                            <span class="info-row-label">Exam Title</span>
                            <span class="info-row-value" id="examTitle">...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row-label">Exam Date</span>
                            <span class="info-row-value" id="examDate">...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-row-label">Current Score</span>
                            <div class="current-score">
                                <span class="score-numbers" id="currentScore">0 / 0</span>
                                <span class="score-percentage" id="currentPercentage">(0%)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Questions -->
                <div class="grading-right-column" id="questionsContainer">
                    <div style="text-align:center;padding:40px;color:#6c757d;">Loading questions...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Save Grades Modal -->
    <div class="modal-overlay" id="saveGradesModal">
        <div class="modal modal-save-grades">
            <div class="modal-header-simple">
                <h3>Save Grades?</h3>
                <button class="modal-close-btn" onclick="closeSaveGradesModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p class="modal-description">You are about to save the following grades for <span id="modalStudentName" style="font-weight: 600;"></span>:</p>
                
                <div class="grades-summary">
                    <div class="grades-summary-row">
                        <span class="grades-summary-label">Multiple Choice:</span>
                        <span class="grades-summary-value" id="modalMcqScore">0 marks</span>
                    </div>
                    <div class="grades-summary-row">
                        <span class="grades-summary-label">Essay Questions:</span>
                        <span class="grades-summary-value" id="modalEssayScore">0 marks</span>
                    </div>
                    <div class="grades-summary-row grades-summary-total">
                        <span class="grades-summary-label">Total Score:</span>
                        <span class="grades-summary-value-total" id="modalTotalScore">0/0 (0%)</span>
                    </div>
                </div>

                <div class="modal-footer-buttons">
                    <button type="button" class="btn-modal-cancel" onclick="closeSaveGradesModal()">Cancel</button>
                    <button type="button" class="btn-primary" onclick="saveGrades()">Save Grades</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const submissionId = urlParams.get('submissionId');
        const examId = urlParams.get('examId');

        let gradingData = null;
        let essayGrades = {};

        async function init() {
            if (!submissionId) {
                alert('No submission ID provided');
                window.history.back();
                return;
            }

            try {
                const response = await axios.get(`/grading/submission/${submissionId}`);
                gradingData = response.data;
                
                console.log('Grading data:', gradingData);
                
                // Initialize essay grades
                gradingData.questions.forEach(q => {
                    if (q.question_type === 'essay' && q.student_answer) {
                        essayGrades[q.id] = {
                            submission_answer_id: q.student_answer.submission_answer_id,
                            score: q.student_answer.score || 0,
                            feedback: q.student_answer.feedback || ''
                        };
                    }
                });

                renderPage();
                updateScores();
            } catch (error) {
                console.error('Error loading grading data:', error);
                alert('Failed to load submission: ' + (error.response?.data?.detail || error.message));
                window.history.back();
            }
        }

        function renderPage() {
            renderSubmissionInfo();
            renderQuestions();
        }

        function renderSubmissionInfo() {
            const sub = gradingData.submission;
            const exam = gradingData.exam;

            document.getElementById('submissionIdDisplay').textContent = `Submission ID: ${sub.id}`;
            document.getElementById('studentName').textContent = sub.student_name;
            document.getElementById('studentEmailDisplay').textContent = sub.student_email;
            document.getElementById('studentAvatarLarge').textContent = getInitials(sub.student_name);
            document.getElementById('submittedAt').textContent = sub.submitted_at || 'N/A';
            document.getElementById('examTitle').textContent = exam.title;
            document.getElementById('examDate').textContent = exam.date || 'N/A';
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            let html = '';

            const mcqQuestions = gradingData.questions.filter(q => q.question_type === 'mcq');
            const essayQuestions = gradingData.questions.filter(q => q.question_type === 'essay');

            // MCQ Section
            if (mcqQuestions.length > 0) {
                const mcqTotal = mcqQuestions.reduce((sum, q) => sum + q.marks, 0);
                const mcqEarned = mcqQuestions.reduce((sum, q) => {
                    return sum + (q.student_answer?.score || 0);
                }, 0);

                html += `
                    <div class="grading-section">
                        <div class="grading-section-header">
                            <h3 class="grading-section-title">Multiple Choice Questions</h3>
                            <span class="grading-section-score">Score: ${mcqEarned}/${mcqTotal}</span>
                        </div>
                `;

                mcqQuestions.forEach((q, index) => {
                    const answer = q.student_answer;
                    const isCorrect = answer?.is_correct || false;
                    const selectedOptionId = answer?.selected_option_id;

                    html += `
                        <div class="grading-question-card">
                            <div class="grading-question-header">
                                <div class="grading-question-number">${index + 1}</div>
                                <span class="grading-question-points">${q.marks} marks</span>
                                <span class="grading-status-badge ${isCorrect ? 'correct' : 'incorrect'}">${isCorrect ? 'Correct' : 'Incorrect'}</span>
                            </div>
                            <div class="grading-question-content">
                                <p class="grading-question-text">${q.question_text}</p>
                                <div class="grading-options-list">
                    `;

                    q.options.forEach((opt, optIndex) => {
                        const isSelected = selectedOptionId === opt.id;
                        const isCorrectOpt = opt.is_correct;
                        let optionClass = 'grading-option';
                        
                        if (isSelected && isCorrectOpt) {
                            optionClass += ' grading-option-selected grading-option-correct';
                        } else if (isSelected && !isCorrectOpt) {
                            optionClass += ' grading-option-selected grading-option-wrong';
                        } else if (!isSelected && isCorrectOpt) {
                            optionClass += ' grading-option-correct';
                        }

                        html += `
                            <div class="${optionClass}">
                                <div class="grading-option-label">${String.fromCharCode(65 + optIndex)}.</div>
                                <span class="grading-option-text">${opt.option_text}</span>
                                ${(isSelected || isCorrectOpt) ? `
                                    <svg class="grading-option-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        ${isCorrectOpt ? '<polyline points="20 6 9 17 4 12"/>' : '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>'}
                                    </svg>
                                ` : ''}
                            </div>
                        `;
                    });

                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            // Essay Section
            if (essayQuestions.length > 0) {
                const essayTotal = essayQuestions.reduce((sum, q) => sum + q.marks, 0);
                const essayEarned = Object.values(essayGrades).reduce((sum, g) => sum + g.score, 0);

                html += `
                    <div class="grading-section">
                        <div class="grading-section-header">
                            <h3 class="grading-section-title">Essay Questions - Manual Grading Required</h3>
                            <span class="grading-section-score">Essay Score: <span id="essayTotalScore">${essayEarned}</span>/${essayTotal}</span>
                        </div>
                `;

                essayQuestions.forEach((q, index) => {
                    const answer = q.student_answer;
                    const currentMarks = essayGrades[q.id]?.score || 0;
                    const currentFeedback = essayGrades[q.id]?.feedback || '';

                    html += `
                        <div class="grading-question-card">
                            <div class="grading-question-header">
                                <div class="grading-question-number">${mcqQuestions.length + index + 1}</div>
                                <span class="grading-question-points">Max ${q.marks} marks</span>
                            </div>
                            <div class="grading-question-content">
                                <p class="grading-question-text">${q.question_text}</p>
                                
                                ${q.rubric ? `
                                    <div class="essay-rubric-section">
                                        <h4 class="essay-section-label">Grading Rubric:</h4>
                                        <p style="color: #6c757d; font-size: 14px;">${q.rubric}</p>
                                    </div>
                                ` : ''}
                                
                                <div class="essay-answer-section">
                                    <h4 class="essay-section-label">Student Answer:</h4>
                                    <div class="essay-answer-text">
                                        <p>${answer?.essay_answer || 'No answer provided'}</p>
                                    </div>
                                </div>

                                <div class="essay-grading-section">
                                    <div class="essay-grading-row">
                                        <div class="essay-grading-input-group">
                                            <label for="essayMarks${q.id}">Marks Awarded</label>
                                            <input type="number" id="essayMarks${q.id}" class="essay-marks-input" 
                                                min="0" max="${q.marks}" value="${currentMarks}" 
                                                oninput="updateEssayGrade(${q.id}, ${q.marks})">
                                        </div>
                                        <div class="essay-feedback-group">
                                            <label for="essayFeedback${q.id}">Feedback (Optional)</label>
                                            <textarea id="essayFeedback${q.id}" class="essay-feedback-input" 
                                                placeholder="Add feedback for the student..." 
                                                rows="3" oninput="updateEssayFeedback(${q.id})">${currentFeedback}</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            container.innerHTML = html;
        }

        function updateEssayGrade(questionId, maxPoints) {
            const marksInput = document.getElementById(`essayMarks${questionId}`);
            let marks = parseFloat(marksInput.value) || 0;
            
            if (marks > maxPoints) marks = maxPoints;
            if (marks < 0) marks = 0;
            marksInput.value = marks;

            if (essayGrades[questionId]) {
                essayGrades[questionId].score = marks;
            }

            updateScores();
        }

        function updateEssayFeedback(questionId) {
            const feedbackInput = document.getElementById(`essayFeedback${questionId}`);
            if (essayGrades[questionId]) {
                essayGrades[questionId].feedback = feedbackInput.value;
            }
        }

        function updateScores() {
            const mcqQuestions = gradingData.questions.filter(q => q.question_type === 'mcq');
            const mcqScore = mcqQuestions.reduce((sum, q) => sum + (q.student_answer?.score || 0), 0);
            
            const essayScore = Object.values(essayGrades).reduce((sum, g) => sum + g.score, 0);
            
            const essayTotalElement = document.getElementById('essayTotalScore');
            if (essayTotalElement) {
                essayTotalElement.textContent = essayScore;
            }

            const totalPoints = gradingData.questions.reduce((sum, q) => sum + q.marks, 0);
            const earnedPoints = mcqScore + essayScore;
            const percentage = totalPoints > 0 ? ((earnedPoints / totalPoints) * 100).toFixed(1) : 0;

            document.getElementById('currentScore').textContent = `${earnedPoints} / ${totalPoints}`;
            document.getElementById('currentPercentage').textContent = `(${percentage}%)`;
        }

        function openSaveGradesModal() {
            const mcqQuestions = gradingData.questions.filter(q => q.question_type === 'mcq');
            const mcqScore = mcqQuestions.reduce((sum, q) => sum + (q.student_answer?.score || 0), 0);
            
            const essayScore = Object.values(essayGrades).reduce((sum, g) => sum + g.score, 0);
            
            const totalPoints = gradingData.questions.reduce((sum, q) => sum + q.marks, 0);
            const earnedPoints = mcqScore + essayScore;
            const percentage = totalPoints > 0 ? ((earnedPoints / totalPoints) * 100).toFixed(1) : 0;

            document.getElementById('modalStudentName').textContent = gradingData.submission.student_name;
            document.getElementById('modalMcqScore').textContent = `${mcqScore} marks`;
            document.getElementById('modalEssayScore').textContent = `${essayScore} marks`;
            document.getElementById('modalTotalScore').textContent = `${earnedPoints}/${totalPoints} (${percentage}%)`;

            document.getElementById('saveGradesModal').classList.add('active');
        }

        function closeSaveGradesModal() {
            document.getElementById('saveGradesModal').classList.remove('active');
        }

        async function saveGrades() {
            try {
                const mcqQuestions = gradingData.questions.filter(q => q.question_type === 'mcq');
                const mcqScore = mcqQuestions.reduce((sum, q) => sum + (q.student_answer?.score || 0), 0);
                const essayScore = Object.values(essayGrades).reduce((sum, g) => sum + g.score, 0);
                const totalScore = mcqScore + essayScore;

                const payload = {
                    submission_id: parseInt(submissionId),
                    essay_grades: Object.values(essayGrades),
                    total_score: totalScore,
                    score_grade: calculateGrade(totalScore, gradingData.questions.reduce((sum, q) => sum + q.marks, 0)),
                    overall_feedback: null
                };

                await axios.post('/grading/save', payload);
                
                alert('Grades saved successfully!');
                closeSaveGradesModal();
                
                setTimeout(() => {
                    window.location.href = `/examDetails?id=${examId}`;
                }, 500);
            } catch (error) {
                console.error('Error saving grades:', error);
                alert('Failed to save grades: ' + (error.response?.data?.detail || error.message));
            }
        }

        function calculateGrade(score, total) {
            const percentage = (score / total) * 100;
            if (percentage >= 90) return 'A';
            if (percentage >= 80) return 'B';
            if (percentage >= 70) return 'C';
            if (percentage >= 60) return 'D';
            return 'F';
        }

        function goBack() {
            window.location.href = `/examDetails?id=${examId}`;
        }

        init();
    </script>
</body>
</html>