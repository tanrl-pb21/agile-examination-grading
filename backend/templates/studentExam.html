<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Examinations - Student Portal</title>
    <link rel="stylesheet" href="../static/style.css">
    <script src="../static/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>Exam Management</h1>
            <p>Student Dashboard</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="/studentExam" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M9 9h6M9 13h6M9 17h4"/>
                </svg>
                Examinations
            </a>
            <a href="/studentSubmissionList" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Submission
            </a>
            <a href="#" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                </svg>
                Reports
            </a>
            <a href="#" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Settings
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-avatar">T</div>
            <div class="user-info">
                <h4>Student</h4>
                <p>student@school.edu</p>
            </div>
        </div>
    </aside>
    <div class="student-container">
        <div class="student-header">
            <div>
                <h1 class="student-main-title">My Examinations</h1>
                <p class="student-subtitle">View and take your scheduled exams</p>
            </div>
            <div class="current-time">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
                <span>Current Time: <span id="currentTime">Loading...</span></span>
            </div>
        </div>

        <div class="student-search-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
            </svg>
            <input type="text" id="examSearchInput" placeholder="Search by title, exam code, or course...">
        </div>

        <div id="loadingState" style="text-align: center; padding: 40px; display: none;">
            <p>Loading exams...</p>
        </div>

        <div id="errorState" style="text-align: center; padding: 40px; color: #ef4444; display: none;">
            <p id="errorMessage">Failed to load exams. Please try again.</p>
        </div>

        <div class="exam-cards-grid" id="examCardsContainer"></div>

        <div class="exam-rules-box">
            <div class="exam-rules-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <span>Exam Rules</span>
            </div>
            <ul class="exam-rules-list">
                <li>Exams can only be opened during the scheduled time window</li>
                <li>You must complete the exam before the end time</li>
                <li>Once started, the exam must be completed in one session</li>
                <li>Make sure you have a stable internet connection</li>
            </ul>
        </div>
    </div>

    <script>
        checkAccess(["student"]);
        let examsData = [];
        let allExamsData = [];
        // Get student ID from session, URL parameter, or authentication
        // For example, you might get this from a logged-in user session
        const studentId = getStudentId(); // You'll need to implement this function

        function getStudentId() {
            // Option 1: Get from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('student_id');
            if (id) return id;
            
            // Option 2: Get from session storage
            const sessionId = sessionStorage.getItem('student_id');
            if (sessionId) return sessionId;
            
            // Option 3: Get from a global variable set by your auth system
            // return window.currentUserId;
            
            // Default fallback - you should replace this with your auth logic
            return 1;
        }

        async function fetchExams() {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const container = document.getElementById('examCardsContainer');

            try {
                loadingState.style.display = 'block';
                errorState.style.display = 'none';
                container.innerHTML = '';

                // Updated to fetch exams for specific student
                const response = await axios.get(`/exams/student/${studentId}`);
                examsData = response.data;
                allExamsData = response.data;

                loadingState.style.display = 'none';
                renderExamCards();
            } catch (error) {
                console.error('Error fetching exams:', error);
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
                document.getElementById('errorMessage').textContent = 
                    error.response?.data?.detail || 'Failed to load exams. Please try again.';
            }
        }

        function isExamAvailable(exam) {
            const now = new Date();
            const startDateTime = new Date(`${exam.date} ${exam.start_time}`);
            const endDateTime = new Date(`${exam.date} ${exam.end_time}`);
            return now >= startDateTime && now <= endDateTime;
        }

        function getExamStatus(exam) {
            const now = new Date();
            const startDateTime = new Date(`${exam.date} ${exam.start_time}`);
            const endDateTime = new Date(`${exam.date} ${exam.end_time}`);

            if (now < startDateTime) {
                return 'upcoming';
            } else if (now > endDateTime) {
                return 'ended';
            } else {
                return 'active';
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatTime(timeStr) {
            const [hours, minutes] = timeStr.split(':');
            const date = new Date();
            date.setHours(parseInt(hours), parseInt(minutes));
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        function handleExamAccess(examId) {
            const exam = allExamsData.find(e => e.id === examId);
            if (!exam) return;

            if (isExamAvailable(exam)) {
                window.location.href = `/studentTakingExam?exam_code=${exam.exam_code}`;
            } else {
                const now = new Date();
                const startDateTime = new Date(`${exam.date} ${exam.start_time}`);
                const endDateTime = new Date(`${exam.date} ${exam.end_time}`);

                if (now < startDateTime) {
                    alert(`This exam is not yet available. It will start at ${formatTime(exam.start_time)} on ${formatDate(exam.date)}`);
                } else {
                    alert('This exam has ended and is no longer available.');
                }
            }
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour12: true });
            document.getElementById('currentTime').textContent = timeString;
            
            if (now.getSeconds() === 0) {
                renderExamCards();
            }
        }

        function renderExamCards() {
            const container = document.getElementById('examCardsContainer');
            
            if (examsData.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No exams available for your enrolled courses.</p>';
                return;
            }

            container.innerHTML = examsData.map(exam => {
                const status = getExamStatus(exam);
                const isAvailable = isExamAvailable(exam);
                
                return `
                    <div class="exam-card">
                        <div class="exam-card-header">
                            <h3 class="exam-card-title">${exam.title}</h3>
                            <span class="exam-status-badge status-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                        </div>
                        <div class="exam-card-id">${exam.exam_code}</div>
                        
                        <div class="exam-card-details">
                            <div class="exam-detail-row">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <path d="M9 9h6M9 13h6M9 17h4"/>
                                </svg>
                                <span>${exam.course_name} (${exam.course_code})</span>
                            </div>
                            <div class="exam-detail-row">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                <span>Date: ${formatDate(exam.date)}</span>
                            </div>
                            <div class="exam-detail-row">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                                <span>Start Time: ${formatTime(exam.start_time)}</span>
                            </div>
                            <div class="exam-detail-row">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                                <span>End Time: ${formatTime(exam.end_time)}</span>
                            </div>
                            <div class="exam-detail-row">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                                <span>Duration: ${exam.duration} minutes</span>
                            </div>
                        </div>

                        ${status === 'ended' ? `
                            <div class="exam-end-notice">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4M12 8h.01"/>
                                </svg>
                                <span>Exam ended at ${formatTime(exam.end_time)}</span>
                            </div>
                        ` : ''}

                        ${status === 'upcoming' ? `
                            <div class="exam-end-notice" style="background: #dbeafe; border-color: #3b82f6;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4M12 8h.01"/>
                                </svg>
                                <span>Exam starts at ${formatTime(exam.start_time)}</span>
                            </div>
                        ` : ''}

                        <button 
                            class="${isAvailable ? 'exam-locked-btn' : 'exam-locked-btn'}" 
                            onclick="handleExamAccess(${exam.id})"
                            style="width: 100%; padding: 12px; background: ${isAvailable ? '#10b981' : '#e5e7eb'}; color: ${isAvailable ? 'white' : '#6b7280'}; border: none; border-radius: 6px; font-weight: 600; cursor: ${isAvailable ? 'pointer' : 'not-allowed'}; display: flex; align-items: center; justify-content: center; gap: 8px; opacity: ${isAvailable ? '1' : '0.6'};"
                            ${!isAvailable ? 'disabled' : ''}
                        >
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 ${isAvailable ? '9.9' : '10'}-${isAvailable ? '1' : '0'}v${isAvailable ? '' : '4'}"/>
                            </svg>
                            ${isAvailable ? 'Open Exam' : `Exam ${status === 'upcoming' ? 'Not Started' : 'Locked'}`}
                        </button>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('examSearchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            examsData = allExamsData.filter(exam => 
                exam.title.toLowerCase().includes(searchTerm) ||
                exam.exam_code.toLowerCase().includes(searchTerm) ||
                exam.course_name.toLowerCase().includes(searchTerm) ||
                exam.course_code.toLowerCase().includes(searchTerm)
            );
            renderExamCards();
        });

        setInterval(updateTime, 1000);
        updateTime();
        fetchExams();

        setInterval(() => {
            renderExamCards();
        }, 60000);
    </script>
</body>
</html>