<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Management - Teacher Dashboard</title>
    <link rel="stylesheet" href="../static/style.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Exam Management</h1>
                <p>Teacher Dashboard</p>
            </div>
            
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M9 9h6M9 13h6M9 17h4"/>
                    </svg>
                    Examinations
                </a>
                <a href="#" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Students
                </a>
                <a href="#" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                        <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                    </svg>
                    Reports
                </a>
                <a href="#" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Settings
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-avatar">T</div>
                <div class="user-info">
                    <h4>Teacher</h4>
                    <p>teacher@school.edu</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div class="page-title">
                    <h2>Examination List</h2>
                    <p>Manage and monitor all examinations</p>
                </div>
                <button class="btn-primary" onclick="openModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add New Exam
                </button>
            </div>

            <div class="search-filter-section">
                <div class="search-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search by title or exam ID..." onkeyup="filterExams()">
                </div>
                <div class="filter-dropdown">
                    <select id="statusFilter" onchange="filterExams()">
                        <option value="all">All Status</option>
                        <option value="ongoing">Ongoing</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>TITLE</th>
                            <th>EXAM ID</th>
                            <th>DATE</th>
                            <th>START TIME</th>
                            <th>END TIME</th>
                            <th>DURATION</th>
                            <th>STATUS</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="examTableBody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Add/Edit Exam Modal -->
    <div class="modal-overlay" id="examModal">
        <div class="modal modal-stepper">
            <!-- Modal Header -->
            <div class="modal-header-stepper">
                <div>
                    <h3 id="examModalTitle">Create New Exam</h3>
                    <p class="modal-step-text">Step 1: Basic Information</p>
                </div>
                <button class="modal-close-btn" onclick="closeModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <form id="examForm" onsubmit="saveExam(event)">
                    <input type="hidden" id="examEditId" value="">
                    
                    <div class="form-group">
                        <label>Exam Title <span class="required">*</span></label>
                        <input type="text" id="examTitle" required placeholder="e.g., Mathematics Final Exam">
                    </div>
                    
                    <div class="form-group">
                        <label>Exam Code <span class="required">*</span></label>
                        <input type="text" id="examIdInput" required placeholder="e.g., MATH2025-FINAL">
                    </div>

                    <div class="form-group">
                        <label>Course <span class="required">*</span></label>
                        <select id="courseCode" required>
                            <option value="">Select a course</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Exam Date <span class="required">*</span></label>
                        <input type="date" id="examDate" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Time <span class="required">*</span></label>
                            <input type="time" id="examStartTime" required>
                        </div>
                        <div class="form-group">
                            <label>End Time <span class="required">*</span></label>
                            <input type="time" id="examEndTime" required>
                        </div>
                    </div>

                    <div id="errorContainer" style="display:none; color:red; margin:10px 0; padding:10px; background:#ffe6e6; border-radius:4px;"></div>
                    
                    <div class="modal-footer-buttons">
                        <button type="button" class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn-primary" id="examSubmitBtn">Next: Add Questions</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let exams = [];
        let courses = [];

        // Configure axios with proper timeout and error handling
        // axios.defaults.baseURL = 'http://localhost:8000';
        axios.defaults.timeout = 10000;

        // Load both exams and courses on page load
        async function initializeData() {
            await Promise.all([loadCourses(), loadExams()]);
        }

       async function loadCourses() {
            try {
                console.log('Fetching courses from /courses...');
                
                const res = await axios.get('/courses', {
                    timeout: 10000,  // 5 seconds instead of 30
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Courses response:', res.data);
                
                // Handle different response formats
                if (Array.isArray(res.data)) {
                    courses = res.data;
                } else if (res.data?.data && Array.isArray(res.data.data)) {
                    courses = res.data.data;
                } else if (res.data?.courses && Array.isArray(res.data.courses)) {
                    courses = res.data.courses;
                } else {
                    console.warn('Unexpected response format:', res.data);
                    courses = [];
                }
                
                console.log('Courses loaded:', courses.length, 'courses');
                updateCourseSelect();
                
            } catch (err) {
                console.error('Error details:', {
                    message: err.message,
                    code: err.code,
                    status: err.response?.status,
                    config: err.config?.url
                });
                
                if (err.code === 'ECONNABORTED') {
                    showError('⏱️ Courses request timed out. Backend may not be responding. Check if server is running on port 8000');
                } else if (err.response?.status === 404) {
                    showError('❌ /courses endpoint not found. Check your backend routes.');
                } else if (err.response?.status >= 500) {
                    showError('❌ Server error loading courses. Check backend logs.');
                } else if (err.message.includes('Network')) {
                    showError('❌ Network error. Check if backend is running.');
                } else {
                    showError('❌ Failed to load courses: ' + err.message);
                }
                
                const courseSelect = document.getElementById('courseCode');
                courseSelect.innerHTML = '<option value="">Backend not responding</option>';
            }
        }

        function updateCourseSelect() {
            const courseSelect = document.getElementById('courseCode');
            
            if (!courseSelect) {
                console.error('Course select element not found');
                return;
            }

            courseSelect.innerHTML = '<option value="">Select a course</option>';

            if (!courses || courses.length === 0) {
                console.warn('No courses available');
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No courses available';
                option.disabled = true;
                courseSelect.appendChild(option);
                return;
            }

            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id || course.course_id;
                option.textContent = `${course.course_code || 'N/A'} - ${course.course_name || 'N/A'}`;
                courseSelect.appendChild(option);
            });
        }

        async function loadExams() {
            const tbody = document.getElementById('examTableBody');
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center">Loading exams...</td></tr>`;
            
            try {
                console.log('Fetching exams...');
                const response = await axios.get('/exams');
                
                if (!response.data) {
                    throw new Error('No data returned from exams endpoint');
                }

                exams = Array.isArray(response.data) ? response.data : [];
                console.log('Exams loaded:', exams);
                renderExams(exams);
            } catch (error) {
                console.error('Failed to load exams:', error);
                const errorMsg = error.response?.status === 404 
                    ? 'Exams endpoint not found' 
                    : error.message;
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:red">Failed to load exams: ${errorMsg}</td></tr>`;
            }
        }

        // In your saveExam function, replace the time reading part:

        async function saveExam(e) {
            e.preventDefault();

            const editId = document.getElementById('examEditId').value;
            
            // Get raw time values from input (format: HH:MM in 24-hour)
            const startTimeRaw = document.getElementById('examStartTime').value;
            const endTimeRaw = document.getElementById('examEndTime').value;
            
            const errorContainer = document.getElementById('errorContainer');

            // Clear previous errors
            errorContainer.style.display = 'none';
            errorContainer.innerHTML = '';

            // Validate times exist
            if (!startTimeRaw || !endTimeRaw) {
                showFormError('Start time and end time are required');
                return;
            }

            // Validate time format (should be HH:MM)
            const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            if (!timeRegex.test(startTimeRaw) || !timeRegex.test(endTimeRaw)) {
                showFormError('Time must be in valid HH:MM format');
                return;
            }

            // Compare times
            if (startTimeRaw >= endTimeRaw) {
                showFormError('End time must be after start time');
                return;
            }

            const examData = {
                title: document.getElementById('examTitle').value.trim(),
                exam_code: document.getElementById('examIdInput').value.trim(),
                date: document.getElementById('examDate').value,
                start_time: startTimeRaw,  // Send as HH:MM format
                end_time: endTimeRaw,      // Send as HH:MM format
                status: 'scheduled',
                course: document.getElementById('courseCode').value,
            };

            // Validate all required fields
            if (!examData.title || !examData.exam_code || !examData.date || !examData.course) {
                showFormError('All fields are required');
                return;
            }

            try {
                let response;
                const url = editId ? `/exams/${editId}` : '/exams';
                const method = editId ? axios.put : axios.post;

                console.log(`${editId ? 'Updating' : 'Creating'} exam:`, examData);
                response = await method(url, examData);

                const savedExam = response.data;
                console.log('Exam saved successfully:', savedExam);

                if (editId) {
                    const idx = exams.findIndex(e => e.id === parseInt(editId));
                    if (idx > -1) {
                        exams[idx] = savedExam;
                    }
                    alert('Exam updated successfully!');
                } else {
                    exams.push(savedExam);
                    alert('Exam created successfully!');
                }

                renderExams(exams);
                closeModal();
            } catch (error) {
                console.error('Save exam error:', error);
                let errorMsg = 'An error occurred while saving the exam';

                const startTimeRaw = document.getElementById('examStartTime').value;
                const endTimeRaw = document.getElementById('examEndTime').value;

                // DEBUG: Log exactly what we're sending
                console.log('=== TIME DEBUG ===');
                console.log('Start time raw value:', startTimeRaw);
                console.log('Start time type:', typeof startTimeRaw);
                console.log('Start time length:', startTimeRaw.length);
                console.log('End time raw value:', endTimeRaw);
                console.log('=== END DEBUG ===');

                // Check if it matches HH:MM format
                const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
                console.log('Start time matches HH:MM?', timeRegex.test(startTimeRaw));
                console.log('End time matches HH:MM?', timeRegex.test(endTimeRaw));

                if (error.response) {
                    if (error.response.status === 422) {
                        const errors = error.response.data.detail;
                        errorMsg = 'Validation errors:\n\n' + 
                            errors.map(err => `• ${err.loc[err.loc.length - 1]}: ${err.msg}`).join('\n');
                    } else if (error.response.status === 400) {
                        errorMsg = error.response.data.detail || 'Bad request';
                    } else {
                        errorMsg = `Server error (${error.response.status}): ${error.response.statusText}`;
                    }
                } else if (error.request) {
                    errorMsg = 'No response from server. Check your connection.';
                } else {
                    errorMsg = `Network error: ${error.message}`;
                }

                showFormError(errorMsg);
            }
        }

        function showFormError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = message;
            errorContainer.style.display = 'block';
        }

        function showError(message) {
            console.error(message);
            alert(message);
        }

        function renderExams(data) {
            const tbody = document.getElementById('examTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#6c757d;">No exams found</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(exam => `
                <tr>
                    <td>${exam.title || 'N/A'}</td>
                    <td>${exam.exam_code || 'N/A'}</td>
                    <td>${exam.date || 'N/A'}</td>
                    <td>${exam.start_time || 'N/A'}</td>
                    <td>${exam.end_time || 'N/A'}</td>
                    <td>${exam.duration ? exam.duration + ' min' : 'N/A'}</td>
                    <td><span class="status-badge status-${exam.status || 'unknown'}">${
    exam.status ? exam.status.charAt(0).toUpperCase() + exam.status.slice(1) : 'Unknown'}</span></td>
                    <td class="actions">
                        <a href="/examDetails?id=${exam.id}" class="action-btn view" title="View">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </a>
                        <button class="action-btn edit" title="Edit" onclick="editExam(${exam.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="action-btn delete" title="Delete" onclick="deleteExam(${exam.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function filterExams() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            
            const filtered = exams.filter(exam => {
                const matchSearch = (exam.title && exam.title.toLowerCase().includes(search)) || 
                                   (exam.exam_code && exam.exam_code.toLowerCase().includes(search));
                const matchStatus = status === 'all' || exam.status === status;
                return matchSearch && matchStatus;
            });
            
            renderExams(filtered);
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            renderExams(exams);
        }

        function resetForm() {
            document.getElementById('examForm').reset();
            document.getElementById('examEditId').value = '';
            document.getElementById('errorContainer').style.display = 'none';
        }

        function openModal() {
            resetForm();
            updateCourseSelect();
            document.getElementById('examModalTitle').textContent = 'Create New Exam';
            document.getElementById('examSubmitBtn').textContent = 'Next: Add Questions';
            document.getElementById('examModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('examModal').classList.remove('active');
            resetForm();
        }

        function editExam(id) {
            const exam = exams.find(e => e.id === id);
            
            if (!exam) {
                alert('Exam not found');
                return;
            }

            document.getElementById('examEditId').value = id;
            document.getElementById('examTitle').value = exam.title || '';
            document.getElementById('examIdInput').value = exam.exam_code || '';
            document.getElementById('examDate').value = exam.date || '';
            document.getElementById('examStartTime').value = exam.start_time || '';
            document.getElementById('examEndTime').value = exam.end_time || '';
            document.getElementById('courseCode').value = exam.course || '';

            document.getElementById('examModalTitle').textContent = 'Edit Exam';
            document.getElementById('examSubmitBtn').textContent = 'Save Changes';
            document.getElementById('examModal').classList.add('active');
        }

        async function deleteExam(id) {
            if (!confirm('Are you sure you want to delete this exam?')) {
                return;
            }

            try {
                await axios.delete(`/exams/${id}`);
                exams = exams.filter(e => e.id !== id);
                renderExams(exams);
                alert('Exam deleted successfully!');
            } catch (error) {
                console.error('Delete exam error:', error);
                alert('Failed to delete exam: ' + (error.response?.data?.detail || error.message));
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', initializeData);
    </script>
</body>
</html>