<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Management - Teacher Dashboard</title>
    <link rel="stylesheet" href="../static/style.css">
    <script src="../static/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Exam Management</h1>
                <p>Teacher Dashboard</p>
            </div>
            
            <nav class="sidebar-nav">
                <a href="/examManagement" class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <path d="M9 9h6M9 13h6M9 17h4"/>
                    </svg>
                    Examinations
                </a>
                <!-- <a href="/studentExam" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Students
                </a> -->
                <a href="/reports" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                        <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                    </svg>
                    Reports
                </a>
                <a href="#" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Settings
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-avatar">T</div>
                <div class="user-info">
                    <h4>Teacher</h4>
                    <p>teacher@school.edu</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div class="page-title">
                    <h2>Examination List</h2>
                    <p>Manage and monitor all examinations</p>
                </div>
                <button class="btn-primary" onclick="openModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add New Exam
                </button>
            </div>

            <div class="search-filter-section">
                <div class="search-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search by title or exam ID..." onkeyup="filterExams()">
                </div>

                <div class="filter-dropdown">
                    <select id="statusFilter" onchange="filterExams()">
                        <option value="all">All Status</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="published">Published</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('title')">TITLE</th>
                            <th class="sortable" onclick="sortTable('exam_code')">EXAM ID</th>
                            <th class="sortable" onclick="sortTable('date')">DATE</th>
                            <th>START TIME</th>
                            <th>END TIME</th>
                            <th>DURATION</th>
                            <th>STATUS</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="examTableBody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Add/Edit Exam Modal -->
    <div class="modal-overlay" id="examModal">
        <div class="modal modal-stepper">
            <!-- Modal Header -->
            <div class="modal-header-stepper">
                <div>
                    <h3 id="examModalTitle">Create New Exam</h3>
                    <p class="modal-step-text">Basic Information</p>
                </div>
                <button class="modal-close-btn" onclick="closeModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <form id="examForm" onsubmit="saveExam(event)">
                    <input type="hidden" id="examEditId" value="">
                    
                    <div class="form-group">
                        <label>Exam Title <span class="required">*</span></label>
                        <input type="text" id="examTitle" required placeholder="e.g., Mathematics Final Exam">
                    </div>
                    
                    <div class="form-group">
                        <label>Exam Code <span class="required">*</span></label>
                        <input type="text" id="examIdInput" required placeholder="e.g., MATH2025-FINAL">
                    </div>

                    <div class="form-group">
                        <label>Course <span class="required">*</span></label>
                        <select id="courseCode" required>
                            <option value="">Select a course</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Exam Date <span class="required">*</span></label>
                        <input type="date" id="examDate" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Time <span class="required">*</span></label>
                            <input type="time" id="examStartTime" required>
                        </div>
                        <div class="form-group">
                            <label>End Time <span class="required">*</span></label>
                            <input type="time" id="examEndTime" required>
                        </div>
                    </div>

                    <div id="errorContainer" style="display:none; color:red; margin:10px 0; padding:10px; background:#ffe6e6; border-radius:4px;"></div>
                    
                    <div class="modal-footer-buttons">
                        <button type="button" class="btn-modal-cancel" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn-primary" id="examSubmitBtn">Create Exam</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Setup axios to include JWT token in all requests
        document.addEventListener("DOMContentLoaded", function () {

           
            // Get token from localStorage
            const token = localStorage.getItem('auth_token');
            
            if (!token) {
                console.warn('⚠️ No token found. Redirecting to login...');
                window.location.href = '/login';
                return;
            }
            
            // ✅ Add token to all axios requests
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
            
            console.log('✅ JWT token configured in axios');
             console.log('Auth header:', axios.defaults.headers.common['Authorization']);
            console.log('Exam ID:', examId);

            // Now call your existing functions
            checkAccess(["teacher"]);
            updateSidebarUserInfo();
        });

        let exams = [];
        let courses = [];

        let currentSort = { column: 'date', direction: 'desc' };

        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            const displayedExams = getFilteredExams();
            sortExamsArray(displayedExams, column, currentSort.direction);
            renderExams(displayedExams);
            updateSortIndicators();
        }

        function sortExamsArray(array, column, direction) {
            array.sort((a, b) => {
                let valA, valB;

                switch(column) {
                    case 'title':
                        valA = (a.title || '').toLowerCase();
                        valB = (b.title || '').toLowerCase();
                        break;
                    case 'exam_code':
                        valA = (a.exam_code || '').toLowerCase();
                        valB = (b.exam_code || '').toLowerCase();
                        break;
                    case 'date':
                        valA = new Date(a.date || '1900-01-01');
                        valB = new Date(b.date || '1900-01-01');
                        break;
                    case 'start_time':
                        valA = a.start_time || '00:00';
                        valB = b.start_time || '00:00';
                        break;
                    case 'end_time':
                        valA = a.end_time || '00:00';
                        valB = b.end_time || '00:00';
                        break;
                    case 'duration':
                        valA = a.duration || 0;
                        valB = b.duration || 0;
                        break;
                    case 'status':
                        valA = (a.status || '').toLowerCase();
                        valB = (b.status || '').toLowerCase();
                        break;
                    default:
                        return 0;
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function updateSortIndicators() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
            });

            const columnMap = {
                'title': 0,
                'exam_code': 1,
                'date': 2,
                'start_time': 3,
                'duration': 5,
                'status': 6
            };

            const columnIndex = columnMap[currentSort.column];
            if (columnIndex !== undefined) {
                const th = document.querySelectorAll('th.sortable')[columnIndex];
                if (th) {
                    th.classList.add(currentSort.direction);
                }
            }
        }

        function getFilteredExams() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            
            return exams.filter(exam => {
                const matchSearch = (exam.title && exam.title.toLowerCase().includes(search)) || 
                                (exam.exam_code && exam.exam_code.toLowerCase().includes(search));
                const matchStatus = status === 'all' || exam.status === status;
                return matchSearch && matchStatus;
            });
        }

        // Configure axios with proper timeout and error handling
        // axios.defaults.baseURL = 'http://localhost:8000';
        axios.defaults.timeout = 10000;

        // Load both exams and courses on page load
        async function initializeData() {
            await Promise.all([loadCourses(), loadExams()]);
        }

        async function checkCanPublish(examId) {
            try {
                const response = await axios.get(`/exams/${examId}/can-publish`);
                return response.data; // Returns {can_publish, message, question_count}
            } catch (error) {
                console.error('Error checking publish status:', error);
                return {
                    can_publish: false,
                    message: 'Error checking publish status',
                    question_count: 0
                };
            }
        }

        async function publishExam(examId) {
    try {
        // First check if can publish
        const validation = await checkCanPublish(examId);
        
        if (!validation.can_publish) {
            alert(`Cannot publish: ${validation.message}\n\nQuestions in exam: ${validation.question_count}`);
            return false;
        }
        
        // Confirm with user
        const confirmMsg = `Publish this exam?\n\n${validation.message}\nQuestions: ${validation.question_count}`;
        if (!confirm(confirmMsg)) {
            return false;
        }
        
        // Publish the exam
        const response = await axios.post(`/exams/${examId}/publish`);
        
        alert(`✅ ${response.data.message}`);
        
        // Reload exams or update UI
        await loadExams();
        return true;
        
    } catch (error) {
        console.error('Publish exam error:', error);
        const errorMsg = error.response?.data?.detail || error.message;
        alert(`❌ Failed to publish exam: ${errorMsg}`);
        return false;
    }
}


       async function loadCourses() {
            try {
                console.log('Fetching courses from /courses...');
                
                const res = await axios.get('/courses/my-courses', {
                    timeout: 10000,  // 5 seconds instead of 30
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Courses response:', res.data);
                
                // Handle different response formats
                if (Array.isArray(res.data)) {
                    courses = res.data;
                } else if (res.data?.data && Array.isArray(res.data.data)) {
                    courses = res.data.data;
                } else if (res.data?.courses && Array.isArray(res.data.courses)) {
                    courses = res.data.courses;
                } else {
                    console.warn('Unexpected response format:', res.data);
                    courses = [];
                }
                
                console.log('Courses loaded:', courses.length, 'courses');
                updateCourseSelect();
                
            } catch (err) {
                console.error('Error details:', {
                    message: err.message,
                    code: err.code,
                    status: err.response?.status,
                    config: err.config?.url
                });
                
                if (err.code === 'ECONNABORTED') {
                    showError('⏱️ Courses request timed out. Backend may not be responding. Check if server is running on port 8000');
                } else if (err.response?.status === 404) {
                    showError('❌ /courses endpoint not found. Check your backend routes.');
                } else if (err.response?.status >= 500) {
                    showError('❌ Server error loading courses. Check backend logs.');
                } else if (err.message.includes('Network')) {
                    showError('❌ Network error. Check if backend is running.');
                } else {
                    showError('❌ Failed to load courses: ' + err.message);
                }
                
                const courseSelect = document.getElementById('courseCode');
                courseSelect.innerHTML = '<option value="">Backend not responding</option>';
            }
        }

        function updateCourseSelect() {
            const courseSelect = document.getElementById('courseCode');
            
            if (!courseSelect) {
                console.error('Course select element not found');
                return;
            }

            courseSelect.innerHTML = '<option value="">Select a course</option>';

            if (!courses || courses.length === 0) {
                console.warn('No courses available');
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No courses available';
                option.disabled = true;
                courseSelect.appendChild(option);
                return;
            }

            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id || course.course_id;
                option.textContent = `${course.course_code || 'N/A'} - ${course.course_name || 'N/A'}`;
                courseSelect.appendChild(option);
            });
        }

        async function loadExams() {
    const tbody = document.getElementById('examTableBody');
    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center">Loading exams...</td></tr>`;
    
    try {
        console.log('Fetching exams...');
        const response = await axios.get('/exams');
        
        if (!response.data) {
            throw new Error('No data returned from exams endpoint');
        }

        exams = Array.isArray(response.data) ? response.data : [];
        console.log('Exams loaded:', exams);

        sortExamsArray(exams, currentSort.column, currentSort.direction);
        updateSortIndicators();
        
        // Check and update completed exams
        await checkAndUpdateCompletedExams();
        
        renderExams(exams);
    } catch (error) {
        console.error('Failed to load exams:', error);
        const errorMsg = error.response?.status === 404 
            ? 'Exams endpoint not found' 
            : error.message;
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:red">Failed to load exams: ${errorMsg}</td></tr>`;
    }
}

// Check for completed exams every 30 seconds (optional - for real-time updates)
setInterval(checkAndUpdateCompletedExams, 30000);

// Also check when page becomes visible (user switches back to tab)
document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
        checkAndUpdateCompletedExams();
    }
});

        // In your saveExam function, replace the time reading part:

        async function saveExam(e) {
    e.preventDefault();

    const editId = document.getElementById('examEditId').value;
    
    // Get raw time values from input (format: HH:MM in 24-hour)
    const startTimeRaw = document.getElementById('examStartTime').value;
    const endTimeRaw = document.getElementById('examEndTime').value;
    
    const errorContainer = document.getElementById('errorContainer');

    // Clear previous errors
    errorContainer.style.display = 'none';
    errorContainer.innerHTML = '';

    // Validate times exist
    if (!startTimeRaw || !endTimeRaw) {
        showFormError('Start time and end time are required');
        return;
    }

    // Validate time format (should be HH:MM)
    const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
    if (!timeRegex.test(startTimeRaw) || !timeRegex.test(endTimeRaw)) {
        showFormError('Time must be in valid HH:MM format');
        return;
    }

    // Compare times
    if (startTimeRaw >= endTimeRaw) {
        showFormError('End time must be after start time');
        return;
    }

    const examData = {
        title: document.getElementById('examTitle').value.trim(),
        exam_code: document.getElementById('examIdInput').value.trim(),
        date: document.getElementById('examDate').value,
        start_time: startTimeRaw,
        end_time: endTimeRaw,
        status: 'scheduled',
        course: document.getElementById('courseCode').value,
    };

    // Validate all required fields
    if (!examData.title || !examData.exam_code || !examData.date || !examData.course) {
        showFormError('All fields are required');
        return;
    }

    try {
        let response;
        const url = editId ? `/exams/${editId}` : '/exams';
        const method = editId ? axios.put : axios.post;

        console.log(`${editId ? 'Updating' : 'Creating'} exam:`, examData);
        response = await method(url, examData);

        const savedExam = response.data;
        console.log('Exam saved successfully:', savedExam);

        if (editId) {
            const idx = exams.findIndex(e => e.id === parseInt(editId));
            if (idx > -1) {
                exams[idx] = savedExam;
            }
            alert('Exam updated successfully!');
        } else {
            exams.push(savedExam);
            alert('Exam created successfully!');
        }

        renderExams(exams);
        closeModal();
    } catch (error) {
        console.error('Save exam error:', error);
        let errorMsg = 'An error occurred while saving the exam';

        if (error.response) {
            if (error.response.status === 422) {
                // ✅ IMPROVED: Clean formatting for validation errors
                const errors = error.response.data.detail;
                
                if (Array.isArray(errors)) {
                    // Extract just the error messages without field paths
                    const messages = errors.map(err => {
                        // Check if it's a "Value error" message
                        if (err.msg && err.msg.includes('Value error,')) {
                            // Extract just the message after "Value error, "
                            return err.msg.replace('Value error, ', '');
                        }
                        // Otherwise return the message as-is
                        return err.msg || 'Validation error';
                    });
                    
                    // Join multiple errors with line breaks
                    errorMsg = messages.join('\n');
                } else if (typeof errors === 'string') {
                    errorMsg = errors;
                } else {
                    errorMsg = 'Validation error occurred';
                }
                
            } else if (error.response.status === 400) {
                errorMsg = error.response.data.detail || 'Bad request';
            } else {
                errorMsg = `Server error (${error.response.status}): ${error.response.statusText}`;
            }
        } else if (error.request) {
            errorMsg = 'No response from server. Check your connection.';
        } else {
            errorMsg = `Network error: ${error.message}`;
        }

        showFormError(errorMsg);
    }
    }

        function showFormError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = message;
            errorContainer.style.display = 'block';
        }

        function showError(message) {
            console.error(message);
            alert(message);
        }

        function renderExams(data) {
    const tbody = document.getElementById('examTableBody');
    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#6c757d;">No exams found</td></tr>';
        return;
    }

    tbody.innerHTML = data.map(exam => `
        <tr>
            <td>${exam.title || 'N/A'}</td>
            <td>${exam.exam_code || 'N/A'}</td>
            <td>${exam.date || 'N/A'}</td>
            <td>${exam.start_time || 'N/A'}</td>
            <td>${exam.end_time || 'N/A'}</td>
            <td>${exam.duration ? exam.duration + ' min' : 'N/A'}</td>
            <td><span class="status-badge status-${exam.status || 'unknown'}">${
                exam.status ? exam.status.charAt(0).toUpperCase() + exam.status.slice(1) : 'Unknown'
            }</span></td>
            <td class="actions">
                <a href="/examDetails?id=${exam.id}" class="action-btn view" title="View">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                </a>
                
                ${exam.status === 'scheduled' ? `
                    <!-- Edit button - only for scheduled exams -->
                    <button class="action-btn edit" title="Edit" onclick="editExam(${exam.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </button>
                ` : `
                    <!-- Disabled edit button for published/completed exams -->
                    <button class="action-btn edit" title="Cannot edit ${exam.status} exam" disabled style="opacity:0.3;cursor:not-allowed">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </button>
                `}
                
        
                ${exam.status === 'scheduled' ? `
                    <!-- Delete button - only for scheduled exams -->
                    <button class="action-btn delete" title="Delete" onclick="deleteExam(${exam.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                ` : `
                    <!-- Disabled delete button for published/completed exams -->
                    <button class="action-btn delete" title="Cannot delete ${exam.status} exam" disabled style="opacity:0.3;cursor:not-allowed">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                `}

                  ${exam.status === 'scheduled' ? `
                    <button class="action-btn publish" title="Publish" onclick="publishExam(${exam.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                    </button>
                ` : `
                    <!-- Disabled publish button -->
                    <button class="action-btn publish" title="Already ${exam.status}" disabled style="opacity:0.3;cursor:not-allowed">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                    </button>
                `}
                
            </td>
        </tr>
    `).join('');
}

        function filterExams() {
            const filtered = getFilteredExams();
            sortExamsArray(filtered, currentSort.column, currentSort.direction);
            renderExams(filtered);
            updateSortIndicators();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            renderExams(exams);
        }

        function openModal() {
            resetForm();
            updateCourseSelect();
            document.getElementById('examModalTitle').textContent = 'Create New Exam';
            document.getElementById('examSubmitBtn').textContent = 'Create Exam';
            document.getElementById('examModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('examModal').classList.remove('active');
            resetForm();
        }

        function editExam(id) {
            const exam = exams.find(e => e.id === id);
            
            if (!exam) {
                alert('Exam not found');
                return;
            }

            const examCodeInput = document.getElementById('examIdInput');
            
            document.getElementById('examEditId').value = id;
            document.getElementById('examTitle').value = exam.title || '';
            document.getElementById('examIdInput').value = exam.exam_code || '';
            document.getElementById('examDate').value = exam.date || '';
            document.getElementById('examStartTime').value = exam.start_time || '';
            document.getElementById('examEndTime').value = exam.end_time || '';
            document.getElementById('courseCode').value = exam.course || '';

            // Make exam code read-only during edit
            examCodeInput.readOnly = true;
            examCodeInput.style.backgroundColor = '#f5f5f5';
            examCodeInput.style.cursor = 'not-allowed';

            document.getElementById('examModalTitle').textContent = 'Edit Exam';
            document.getElementById('examSubmitBtn').textContent = 'Save Changes';
            document.getElementById('examModal').classList.add('active');
        }

    // Update the resetForm function to enable exam code field for new exams
    function resetForm() {
        document.getElementById('examForm').reset();
        document.getElementById('examEditId').value = '';
        document.getElementById('errorContainer').style.display = 'none';
        
        // Enable exam code for new exams
        const examCodeInput = document.getElementById('examIdInput');
        examCodeInput.readOnly = false;
        examCodeInput.style.backgroundColor = '';
        examCodeInput.style.cursor = 'auto';
    }

    
    async function checkAndUpdateCompletedExams() {
    try {
        const now = new Date();
        let needsUpdate = false;

        for (const exam of exams) {
            // Skip if already completed
            if (exam.status === 'completed') continue;

            // Parse exam date and end time
            const examDateTime = new Date(`${exam.date}T${exam.end_time}`);

            // If current time is past exam end time, mark as completed
            if (now > examDateTime && exam.status !== 'completed') {
                console.log(`Marking exam ${exam.id} as completed`);
                try {
                    // ✅ NEW: Use the status-only update endpoint with query parameter
                    const response = await axios.patch(
                        `/exams/${exam.id}/status?status=completed`
                    );

                    // Update local exam object
                    const idx = exams.findIndex(e => e.id === exam.id);
                    if (idx > -1) {
                        exams[idx] = response.data;
                    }
                    needsUpdate = true;
                    
                    console.log(`✅ Exam ${exam.id} marked as completed successfully`);
                } catch (error) {
                    console.error(`❌ Error updating exam ${exam.id} to completed:`, error);
                    
                    // Log detailed error info
                    if (error.response) {
                        console.error('Error response:', error.response.data);
                        console.error('Error status:', error.response.status);
                    }
                }
            }
        }

        // Re-render table if any exams were updated
        if (needsUpdate) {
            console.log('✅ Re-rendering exams table after status updates');
            renderExams(exams);
        }
    } catch (error) {
        console.error('❌ Error checking completed exams:', error);
    }
    }

        async function deleteExam(id) {
            if (!confirm('Are you sure you want to delete this exam?')) {
                return;
            }

            try {
                await axios.delete(`/exams/${id}`);
                exams = exams.filter(e => e.id !== id);
                renderExams(exams);
                alert('Exam deleted successfully!');
            } catch (error) {
                console.error('Delete exam error:', error);
                alert('Failed to delete exam: ' + (error.response?.data?.detail || error.message));
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', initializeData);
    </script>
</body>
</html>