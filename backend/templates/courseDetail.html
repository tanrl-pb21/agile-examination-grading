<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/style.css">
    <link rel="stylesheet" href="../static/courseDetail.css">
    <title>Course Details</title>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>Exam Management</h1>
            <p>Admin Dashboard</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="/courseManagement" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <path d="M9 9h6M9 13h6M9 17h4"/>
                </svg>
                Course
            </a>
            <!-- <a href="/studentExam" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Students
            </a>
            <a href="#" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"/>
                </svg>
                Reports
            </a>
            <a href="#" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Settings
            </a> -->
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-avatar">T</div>
            <div class="user-info">
                <h4>Admin</h4>
                <p>admin@school.edu</p>
            </div>
        </div>
    </aside>

    <div class="main-content">
        <div class="course-header">
            <div class="header-top">
                <div class="course-title-section">
                    <div class="course-icon-large">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                        </svg>
                    </div>
                    <div class="course-title-info">
                        <h1 id="courseName">Loading...</h1>
                        <div class="course-meta">
                            <span id="courseMeta">Loading...</span>
                            <span class="status-badge" id="courseStatus">active</span>
                        </div>
                        <div class="instructor-students">
                            <span id="instructorInfo">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                                Loading...
                            </span>
                            <span id="studentCount">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                0 Students
                            </span>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-danger" id="statusBtn" onclick="toggleStatus()">Loading...</button>
                </div>
            </div>
        </div>

        <div class="content-body">
            <div class="main-section">
                <div class="card">
                    <div class="card-title">Course Description</div>
                    <div class="card-description" id="courseDescription">
                        Loading course description...
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Enrolled Students</div>
                    <div class="student-list" id="studentList">
                        <p style="text-align: center; color: #999;">Loading students...</p>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="card">
                    <div class="card-title">Instructors</div>
                    <div id="instructorsList">
                        <p style="text-align: center; color: #999;">Loading instructors...</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Exams</div>
                    <div id="examsList">
                        <p style="text-align: center; color: #999;">Loading exams...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Change Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            </div>
            <h2 class="modal-title" id="modalTitle">Confirm Action</h2>
            <p class="modal-description" id="modalDescription">
                Are you sure you want to proceed?
            </p>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmStatusChange()">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/courses';
        let currentCourse = null;
        let courseId = null;

        // Get course ID from URL
        function getCourseIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Fetch course details
        async function fetchCourseDetails() {
            try {
                courseId = getCourseIdFromURL();
                if (!courseId) {
                    throw new Error('Course ID not found in URL');
                }

                const response = await fetch(`${API_BASE_URL}/${courseId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch course details');
                }

                currentCourse = await response.json();
                renderCourseDetails();
            } catch (error) {
                console.error('Error fetching course details:', error);
                alert('Failed to load course details');
                window.location.href = '/courseManagement';
            }
        }

        // Render course details
        function renderCourseDetails() {
            document.getElementById('courseName').textContent = currentCourse.course_name;
            document.getElementById('courseMeta').textContent = currentCourse.course_code;
            
            const statusBadge = document.getElementById('courseStatus');
            statusBadge.textContent = currentCourse.status || 'active';
            statusBadge.className = `status-badge status-${currentCourse.status || 'active'}`;

            document.getElementById('studentCount').innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                ${currentCourse.number_student || 0} Students
            `;

            document.getElementById('courseDescription').textContent = 
                currentCourse.description || 'No description available.';

            // Update status button
            const statusBtn = document.getElementById('statusBtn');
            if (currentCourse.status === 'active') {
                statusBtn.textContent = 'Deactivate';
                statusBtn.className = 'btn btn-danger';
            } else {
                statusBtn.textContent = 'Activate';
                statusBtn.className = 'btn btn-success';
            }
        }

        // Fetch instructors
        async function fetchInstructors() {
            try {
                const response = await fetch(`${API_BASE_URL}/${courseId}/instructors`);
                if (!response.ok) {
                    throw new Error('Failed to fetch instructors');
                }

                const instructors = await response.json();
                renderInstructors(instructors);
            } catch (error) {
                console.error('Error fetching instructors:', error);
                document.getElementById('instructorsList').innerHTML = 
                    '<p style="color: #c00;">Failed to load instructors</p>';
            }
        }

        // Render instructors
        function renderInstructors(instructors) {
            const container = document.getElementById('instructorsList');
            
            if (instructors.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No instructors assigned</p>';
                document.getElementById('instructorInfo').innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    No instructor assigned
                `;
                return;
            }

            document.getElementById('instructorInfo').innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                ${instructors[0].user_email}
            `;

            container.innerHTML = instructors.map(instructor => `
                <div class="exam-item">
                    <div class="exam-title">${instructor.user_email}</div>
                    <div class="exam-details">
                        <div class="exam-detail">Instructor ID: ${instructor.id}</div>
                    </div>
                </div>
            `).join('');
        }

        // Fetch students
        async function fetchStudents() {
            try {
                const response = await fetch(`${API_BASE_URL}/${courseId}/students`);
                if (!response.ok) {
                    throw new Error('Failed to fetch students');
                }

                const students = await response.json();
                renderStudents(students);
            } catch (error) {
                console.error('Error fetching students:', error);
                document.getElementById('studentList').innerHTML = 
                    '<p style="color: #c00;">Failed to load students</p>';
            }
        }

        // Render students
        function renderStudents(students) {
            const container = document.getElementById('studentList');
            
            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No students enrolled</p>';
                return;
            }

            const colors = ['#cffafe', '#dbeafe', '#d1fae5', '#e0e7ff', '#ccfbf1', '#fce7f3'];
            
            container.innerHTML = students.map((student, index) => `
                <div class="student-item">
                    <div class="student-info">
                        <div class="student-avatar" style="background-color: ${colors[index % colors.length]}; color: #047857;">
                            ${student.user_email.charAt(0).toUpperCase()}
                        </div>
                        <div class="student-details">
                            <div class="student-name">${student.user_email}</div>
                            <div class="student-email">ID: ${student.student_id || student.id}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Fetch exams
        async function fetchExams() {
            try {
                const response = await fetch(`${API_BASE_URL}/${courseId}/exams`);
                if (!response.ok) {
                    throw new Error('Failed to fetch exams');
                }

                const exams = await response.json();
                renderExams(exams);
            } catch (error) {
                console.error('Error fetching exams:', error);
                document.getElementById('examsList').innerHTML = 
                    '<p style="color: #c00;">Failed to load exams</p>';
            }
        }

        // Render exams
        function renderExams(exams) {
            const container = document.getElementById('examsList');
            
            if (exams.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No exams scheduled</p>';
                return;
            }

            container.innerHTML = exams.map(exam => `
                <div class="exam-item">
                    <div class="exam-title">${exam.title}</div>
                    <div class="exam-details">
                        <div class="exam-detail">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            ${exam.date || 'No date'}
                        </div>
                        <div class="exam-detail">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            ${exam.duration || 'N/A'} min
                        </div>
                    </div>
                    <span class="exam-type ${exam.status || 'scheduled'}">${exam.status || 'Scheduled'}</span>
                </div>
            `).join('');
        }

        // Toggle status modal
        function toggleStatus() {
            const newStatus = currentCourse.status === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'activate' : 'deactivate';
            
            document.getElementById('modalTitle').textContent = 
                `${action.charAt(0).toUpperCase() + action.slice(1)} Course?`;
            
            document.getElementById('modalDescription').textContent = 
                newStatus === 'inactive' 
                    ? 'This course will no longer be available for enrollment. Students already enrolled will retain access.'
                    : 'This course will be available for enrollment again.';
            
            document.getElementById('modalOverlay').classList.add('active');
        }

        // Confirm status change
        async function confirmStatusChange() {
            try {
                const newStatus = currentCourse.status === 'active' ? 'inactive' : 'active';
                
                const response = await fetch(`${API_BASE_URL}/${courseId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) {
                    throw new Error('Failed to update course status');
                }

                currentCourse.status = newStatus;
                renderCourseDetails();
                closeModal();
                
                alert(`Course ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully`);
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update course status');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Initialize page
        async function initializePage() {
            await fetchCourseDetails();
            await Promise.all([
                fetchInstructors(),
                fetchStudents(),
                fetchExams()
            ]);
        }

        // Load page
        initializePage();
    </script>
</body>
</html>