<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taking Exam - Student Portal</title>
    <link rel="stylesheet" href="../static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <div class="exam-taking-container">
        <!-- Exam Header -->
        <div class="exam-header-bar">
            <div class="exam-header-left">
                <h2 class="exam-title" id="examTitleHeader">Mathematics Final Examination</h2>
                <p class="exam-id-text">Exam ID: <span id="examIdHeader">MATH-FINAL-2025</span></p>
            </div>
            <div class="exam-header-right">
                <div class="exam-timer" id="examTimer">Time Left: --:--:--</div>
                <div class="exam-progress">
                    <span id="examProgressText">0/0</span>
                </div>
                <button class="btn-submit-exam" onclick="handleSubmitClick()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Submit Exam
                </button>
            </div>
        </div>

        <!-- Questions Container -->
        <div class="questions-container" id="questionsContainer">
            <!-- Questions will be generated here -->
        </div>

        <!-- Submit Button Bottom -->
        <div class="exam-submit-footer">
            <button class="btn-submit-exam-large" onclick="handleSubmitClick()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                Submit Exam
            </button>
        </div>
    </div>

    <script>
        // ===========================
        // GLOBAL STATE
        // ===========================
        let examQuestionsData = [];
        let selectedAnswers = {};
        let currentExamCode = null;
        let currentUserId = 1; // TODO: Get from session/auth system
        let timerInterval = null;

        // ===========================
        // INITIALIZATION
        // ===========================
        function initializeExam() {
            const params = new URLSearchParams(window.location.search);
            currentExamCode = params.get("exam_code");
            
            if (!currentExamCode) {
                alert("No exam code provided!");
                return;
            }
            
            loadExamQuestions(currentExamCode);
            loadExamDuration(currentExamCode);
        }

        // ===========================
        // LOAD EXAM DATA
        // ===========================
        async function loadExamQuestions(examCode) {
            try {
                const res = await axios.get(`/exams/code/${examCode}/questions`);
                const rawQuestions = res.data.questions;
                
                examQuestionsData = transformQuestionsData(rawQuestions);
                renderAllQuestions();
                updateProgressDisplay();
                
            } catch (err) {
                console.error("Error loading exam questions:", err);
                alert("Unable to load exam questions");
            }
        }

        function transformQuestionsData(rawQuestions) {
            return rawQuestions.map((q, index) => ({
                id: q.id,
                type: q.question_type.toLowerCase() === "mcq" 
                    ? "Multiple Choice" 
                    : "Essay Question",
                marks: q.marks,
                questionNumber: index + 1,
                totalQuestions: rawQuestions.length,
                question: q.question_text,
                options: q.options.map((opt, idx) => ({
                    id: opt.id,
                    label: String.fromCharCode(65 + idx), // A, B, C, D...
                    text: opt.option_text
                })),
                note: q.question_type.toLowerCase() === "essay"
                    ? "Write a detailed answer. This will be manually graded by your instructor."
                    : null
            }));
        }

        // ===========================
        // RENDER UI
        // ===========================
        function renderAllQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = examQuestionsData.map(q => {
                return q.type === 'Multiple Choice' 
                    ? renderMCQQuestion(q) 
                    : renderEssayQuestion(q);
            }).join("");
        }

        function renderMCQQuestion(question) {
            return `
                <div class="question-card-student">
                    <div class="question-header-student">
                        <div class="question-type-badge mcq-badge">
                            <span class="question-number-circle">${question.questionNumber}</span>
                            <span>${question.type}</span>
                        </div>
                        <span class="question-marks">${question.marks} marks</span>
                        <span class="question-counter">Question ${question.questionNumber} of ${question.totalQuestions}</span>
                    </div>

                    <div class="question-content-student">
                        <h3 class="question-text-student">${question.question}</h3>

                        <div class="options-list-student">
                            ${renderMCQOptions(question)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMCQOptions(question) {
            return question.options.map(opt => `
                <label class="option-student ${isOptionSelected(question.id, opt.id) ? 'selected' : ''}">
                    <input
                        type="radio"
                        name="question${question.id}"
                        value="${opt.id}"
                        onchange="handleMCQSelection(${question.id}, ${opt.id})"
                        ${isOptionSelected(question.id, opt.id) ? 'checked' : ''}
                    >
                    <span class="option-radio-custom"></span>
                    <span class="option-label">${opt.label}.</span>
                    <span class="option-text">${opt.text}</span>
                </label>
            `).join("");
        }

        function renderEssayQuestion(question) {
            return `
                <div class="question-card-student">
                    <div class="question-header-student">
                        <div class="question-type-badge essay-badge">
                            <span class="question-number-circle">${question.questionNumber}</span>
                            <span>${question.type}</span>
                        </div>
                        <span class="question-marks">${question.marks} marks</span>
                        <span class="question-counter">Question ${question.questionNumber} of ${question.totalQuestions}</span>
                    </div>

                    <div class="question-content-student">
                        <h3 class="question-text-student">${question.question}</h3>
                        <textarea 
                            class="essay-textarea" 
                            rows="10"
                            placeholder="Type your answer here..."
                            oninput="handleEssayInput(${question.id}, this.value)"
                        >${selectedAnswers[question.id] || ''}</textarea>
                        <p class="essay-note">${question.note}</p>
                    </div>
                </div>
            `;
        }

        // ===========================
        // ANSWER HANDLING
        // ===========================
        function handleMCQSelection(questionId, optionId) {
            selectedAnswers[questionId] = optionId;
            updateProgressDisplay();
            renderAllQuestions();
        }

        function handleEssayInput(questionId, value) {
            if (value.trim()) {
                selectedAnswers[questionId] = value;
            } else {
                delete selectedAnswers[questionId];
            }
            updateProgressDisplay();
        }

        function isOptionSelected(questionId, optionId) {
            return selectedAnswers[questionId] == optionId;
        }

        // ===========================
        // PROGRESS TRACKING
        // ===========================
        function updateProgressDisplay() {
            const answered = Object.keys(selectedAnswers).length;
            const total = examQuestionsData.length;
            document.getElementById('examProgressText').textContent = `${answered}/${total}`;
        }

        function getUnansweredCount() {
            const total = examQuestionsData.length;
            const answered = Object.keys(selectedAnswers).length;
            return total - answered;
        }

        // ===========================
        // SUBMISSION
        // ===========================
        function handleSubmitClick() {
            const unanswered = getUnansweredCount();
            
            if (unanswered > 0) {
                const confirmMsg = `You have ${unanswered} unanswered question(s). Do you still want to submit?`;
                if (!confirm(confirmMsg)) {
                    return;
                }
            }
            
            if (confirm("Are you sure you want to submit your exam?")) {
                submitExamToBackend();
            }
        }

        async function submitExamToBackend() {
            try {
                // Prepare submission data
                const submissionData = prepareSubmissionData();
                
                // Send to backend
                const response = await axios.post('/exams/submit', submissionData);
                
                // Handle response
                handleSubmissionResponse(response.data);
                
            } catch (error) {
                console.error("Submission error:", error);
                handleSubmissionError(error);
            }
        }

        function prepareSubmissionData() {
            const answers = Object.entries(selectedAnswers).map(([questionId, answer]) => ({
                question_id: parseInt(questionId),
                answer: answer
            }));
            
            return {
                exam_code: currentExamCode,
                user_id: currentUserId,
                answers: answers
            };
        }

        function handleSubmissionResponse(data) {
            clearInterval(timerInterval);
            
            let message = data.message;
            message += `\n\nScore: ${data.total_score}/${data.max_score}`;
            if (data.grade !== "Pending") {
                message += `\nGrade: ${data.grade}`;
            }
            
            alert(message);
            
            // Redirect to exam list or results page
            window.location.href = "exam-list.html";
        }

        function handleSubmissionError(error) {
            if (error.response) {
                alert(`Submission failed: ${error.response.data.detail}`);
            } else {
                alert("Submission failed. Please check your connection and try again.");
            }
        }

        // ===========================
        // TIMER
        // ===========================
        async function loadExamDuration(examCode) {
            try {
                const res = await axios.get(`/exams/code/${examCode}/duration`);
                const data = res.data;
                startExamTimer(data.remaining_seconds);
                
            } catch (error) {
                console.error("Error loading exam duration:", error);
                alert("Failed to load exam timer.");
            }
        }

        function startExamTimer(remainingSeconds) {
            const timerDisplay = document.getElementById("examTimer");
            
            timerInterval = setInterval(() => {
                const timeStr = formatTime(remainingSeconds);
                timerDisplay.textContent = `Time Left: ${timeStr}`;
                
                remainingSeconds--;
                
                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    alert("Time is up! Submitting exam...");
                    submitExamToBackend();
                }
            }, 1000);
        }

        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hrs.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
        }

        // ===========================
        // PAGE LOAD
        // ===========================
        initializeExam();
    </script>
</body>
</html>