<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taking Exam - Student Portal</title>
    <link rel="stylesheet" href="../static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <div class="exam-taking-container">
        <!-- Exam Header -->
        <div class="exam-header-bar">
            <div class="exam-header-left">
                <h2 class="exam-title" id="examTitleHeader">Mathematics Final Examination</h2>
                <p class="exam-id-text">Exam ID: <span id="examIdHeader">MATH-FINAL-2025</span></p>
            </div>
            <div class="exam-header-right">
                <div class="exam-timer" id="examTimer">Time Left: --:--:--</div>
                <div class="exam-progress">
                    <span id="examProgressText">0/0</span>
                </div>
                <button class="btn-submit-exam" onclick="submitExam()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Submit Exam
                </button>
            </div>
        </div>

        <!-- Questions Container -->
        <div class="questions-container" id="questionsContainer">
            <!-- Questions will be generated here -->
        </div>

        <!-- Submit Button Bottom -->
        <div class="exam-submit-footer">
            <button class="btn-submit-exam-large" onclick="submitExam()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                Submit Exam
            </button>
        </div>
    </div>

    <script>
        let examQuestionsData = [];
        let selectedAnswers = {};
    
        // -------------------------------
        // LOAD QUESTIONS FROM BACKEND
        // -------------------------------
        async function loadExamQuestions(examCode) {
            try {
                const res = await axios.get(`/exams/code/${examCode}/questions`);
                const raw = res.data.questions;
    
                examQuestionsData = raw.map((q, index) => ({
                    id: q.id,
    
                    // Convert DB type → UI type
                    type: q.question_type.toLowerCase() === "mcq"
                        ? "Multiple Choice"
                        : "Essay Question",
    
                    marks: q.marks,
                    questionNumber: index + 1,
                    totalQuestions: raw.length,
                    question: q.question_text,
    
                    // Convert DB options → UI structure
                    options: q.options.map((opt, idx) => ({
                        id: opt.id,   // REAL DB ID (21,22,23,24...)
                        label: String.fromCharCode(65 + idx), // A,B,C,D...
                        text: opt.option_text
                    })),
    
                    note: q.question_type.toLowerCase() === "essay"
                        ? "Write a detailed answer. This will be manually graded by your instructor."
                        : null
                }));
    
                renderExamQuestions();
                updateProgress();
    
            } catch (err) {
                console.error("Error loading exam questions:", err);
                alert("Unable to load exam questions");
            }
        }
    
        // -------------------------------
        // RENDER QUESTIONS (UI)
        // -------------------------------
        function renderExamQuestions() {
            const container = document.getElementById('questionsContainer');
    
            container.innerHTML = examQuestionsData.map(q => {
    
                // === Multiple Choice ===
                if (q.type === 'Multiple Choice') {
                    return `
                        <div class="question-card-student">
                            <div class="question-header-student">
                                <div class="question-type-badge mcq-badge">
                                    <span class="question-number-circle">${q.questionNumber}</span>
                                    <span>${q.type}</span>
                                </div>
                                <span class="question-marks">${q.marks} marks</span>
                                <span class="question-counter">Question ${q.questionNumber} of ${q.totalQuestions}</span>
                            </div>
    
                            <div class="question-content-student">
                                <h3 class="question-text-student">${q.question}</h3>
    
                                <div class="options-list-student">
                                    ${q.options.map(opt => `
                                        <label class="option-student ${selectedAnswers[q.id] == opt.id ? 'selected' : ''}">
                                            <input
                                                type="radio"
                                                name="question${q.id}"
                                                value="${opt.id}"
                                                onchange="selectAnswer(${q.id}, ${opt.id})"
                                                ${selectedAnswers[q.id] == opt.id ? 'checked' : ''}
                                            >
                                            <span class="option-radio-custom"></span>
                                            <span class="option-label">${opt.label}.</span>
                                            <span class="option-text">${opt.text}</span>
                                        </label>
                                    `).join("")}
                                </div>
                            </div>
                        </div>
                    `;
                }
    
                // === Essay ===
                return `
                    <div class="question-card-student">
                        <div class="question-header-student">
                            <div class="question-type-badge essay-badge">
                                <span class="question-number-circle">${q.questionNumber}</span>
                                <span>${q.type}</span>
                            </div>
                            <span class="question-marks">${q.marks} marks</span>
                            <span class="question-counter">Question ${q.questionNumber} of ${q.totalQuestions}</span>
                        </div>
    
                        <div class="question-content-student">
                            <h3 class="question-text-student">${q.question}</h3>
                            <textarea 
                                class="essay-textarea" 
                                rows="10"
                                placeholder="Type your answer here..."
                                oninput="updateEssayAnswer(${q.id}, this.value)"
                            >${selectedAnswers[q.id] || ''}</textarea>
                            <p class="essay-note">${q.note}</p>
                        </div>
                    </div>
                `;
            }).join("");
        }
    
        // -------------------------------
        // SAVE MCQ SELECTION
        // -------------------------------
        function selectAnswer(questionId, optionId) {
            selectedAnswers[questionId] = optionId;
            updateProgress();
            renderExamQuestions(); // refresh highlight + checked state
        }

        // -------------------------------
        // SAVE ESSAY ANSWER
        // -------------------------------
        function updateEssayAnswer(questionId, value) {
            if (value.trim()) {
                selectedAnswers[questionId] = value;
            } else {
                delete selectedAnswers[questionId];
            }
            updateProgress();
        }
    
        // -------------------------------
        // PROGRESS COUNTER (FIXED)
        // -------------------------------
        function updateProgress() {
            const answered = Object.keys(selectedAnswers).length;
            const total = examQuestionsData.length; // ✅ Count ALL questions (MCQ + Essay)
            document.getElementById('examProgressText').textContent = `${answered}/${total}`;
        }
    
        // -------------------------------
        // SUBMIT
        // -------------------------------
        function submitExam() {
            const total = examQuestionsData.length;
            const answered = Object.keys(selectedAnswers).length;
            
            if (answered < total) {
                if (!confirm(`You have only answered ${answered} out of ${total} questions. Do you still want to submit?`)) {
                    return;
                }
            }
            
            if (confirm("Are you sure you want to submit your exam?")) {
                alert("Exam submitted successfully!");
                window.location.href = "exam-list.html";
            }
        }
    
        // -------------------------------
        // TIMER (UNCHANGED)
        // -------------------------------
        async function loadExamDuration(examCode) {
            try {
                const res = await axios.get(`/exams/code/${examCode}/duration`);
                const data = res.data;
    
                let remainingSeconds = data.remaining_seconds;
                const timerDisplay = document.getElementById("examTimer");
    
                const timer = setInterval(() => {
                    let hrs = Math.floor(remainingSeconds / 3600);
                    let mins = Math.floor((remainingSeconds % 3600) / 60);
                    let secs = remainingSeconds % 60;
    
                    timerDisplay.textContent =
                        `Time Left: ${hrs.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
    
                    remainingSeconds--;
    
                    if (remainingSeconds <= 0) {
                        clearInterval(timer);
                        alert("Time is up! Submitting exam...");
                        submitExam();
                    }
                }, 1000);
    
            } catch (error) {
                console.error("Error loading exam duration:", error);
                alert("Failed to load exam timer.");
            }
        }
    
        // -------------------------------
        // ON PAGE LOAD
        // -------------------------------
        const params = new URLSearchParams(window.location.search);
        const examCode = params.get("exam_code");
    
        if (examCode) {
            loadExamQuestions(examCode);
            loadExamDuration(examCode);
        } else {
            alert("No exam code provided!");
        }
    </script>
    
</body>
</html>