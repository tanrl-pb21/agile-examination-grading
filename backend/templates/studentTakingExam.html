<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taking Exam - Student Portal</title>
    <link rel="stylesheet" href="../static/style.css">
    <script src="../static/auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <div class="exam-taking-container">
        <!-- Exam Header -->
        <div class="exam-header-bar">
            <div class="exam-header-left">
                <h2 class="exam-title" id="examTitleHeader">Mathematics Final Examination</h2>
                <p class="exam-id-text">Exam ID: <span id="examIdHeader">MATH-FINAL-2025</span></p>
            </div>
            <div class="exam-header-right">
                <div class="exam-timer" id="examTimer">Time Left: --:--:--</div>
                <div class="exam-progress">
                    <span id="examProgressText">0/0</span>
                </div>
                <button class="btn-submit-exam" id="submitBtnHeader" onclick="handleSubmitClick()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>
                    Submit Exam
                </button>
            </div>
        </div>

        <!-- Questions Container -->
        <div class="questions-container" id="questionsContainer">
            <!-- Questions will be generated here -->
        </div>

        <!-- Submit Button Bottom -->
        <div class="exam-submit-footer">
            <button class="btn-submit-exam-large" id="submitBtnFooter" onclick="handleSubmitClick()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12" />
                </svg>
                Submit Exam
            </button>
        </div>
    </div>

    <!-- Time's Up Modal -->
    <div id="timeUpModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; padding: 40px; border-radius: 10px; max-width: 500px; text-align: center;">
            <h2 style="color: #dc3545; margin-bottom: 20px;">⏰ Time's Up!</h2>
            <p style="font-size: 18px; margin-bottom: 30px;">The exam time has ended. Submissions are no longer
                accepted.</p>
            <p style="color: #666; font-size: 14px;">Please contact your instructor if you have any concerns.</p>
            <button onclick="window.location.href='/studentExam'"
                style="margin-top: 20px; padding: 10px 30px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                Return to Exam List
            </button>
        </div>
    </div>

    <script>
        checkAccess(["student"]);
        // ===========================
        // GLOBAL STATE
        // ===========================
        let examQuestionsData = [];
        let selectedAnswers = {};
        let currentExamCode = null;
        let currentUserId = 1; // TODO: Get from session/auth system
        let timerInterval = null;
        let examHasEnded = false; // Track if exam time is up
        let isSubmitting = false; // Prevent duplicate submissions

        // ===========================
        // INITIALIZATION
        // ===========================
        async function checkIfStudentAlreadySubmitted(examCode, userId) {
            try {
                const res = await axios.get(`/take-exam/check-submission/${examCode}/${userId}`);

                if (res.data.submitted) {
                    alert("You have already submitted this exam. You cannot retake it.");
                    window.location.href = "/studentExam";
                    return false;
                }

                return true;

            } catch (err) {
                console.error(err);
                alert("Something went wrong checking exam status.");
                return false;
            }
        }

        async function checkExamTime(examCode) {
            try {
                const res = await axios.get(`/take-exam/availability/${examCode}`);
                const status = res.data.status;

                if (status === "not_started") {
                    alert("Exam has not started yet.\n\n" + res.data.message);
                    window.location.href = "/studentExam";
                    return false;
                }

                if (status === "ended") {
                    alert("This exam has already ended.\n\n" + res.data.message);
                    window.location.href = "/studentExam";
                    return false;
                }

                return true;

            } catch (err) {
                console.error(err);
                alert("Failed to verify exam time.");
                return false;
            }
        }

        async function initializeExam() {
            const params = new URLSearchParams(window.location.search);
            currentExamCode = params.get("exam_code");

            if (!currentExamCode) {
                alert("No exam code provided!");
                return;
            }

            // 1️⃣ Block if exam not started or already ended
            const timeOk = await checkExamTime(currentExamCode);
            if (!timeOk) return;

            // 2️⃣ Block if student already submitted
            const allowed = await checkIfStudentAlreadySubmitted(currentExamCode, currentUserId);
            if (!allowed) return;

            // 3️⃣ Load exam normally
            loadExamQuestions(currentExamCode);
            loadExamDuration(currentExamCode);
        }

        // ===========================
        // LOAD EXAM DATA
        // ===========================
        async function loadExamQuestions(examCode) {
            try {
                const res = await axios.get(`/take-exam/questions/${examCode}`);
                const rawQuestions = res.data.questions;

                examQuestionsData = transformQuestionsData(rawQuestions);
                renderAllQuestions();
                updateProgressDisplay();

            } catch (err) {
                console.error("Error loading exam questions:", err);
                alert("Unable to load exam questions");
            }
        }

        function transformQuestionsData(rawQuestions) {
            return rawQuestions.map((q, index) => ({
                id: q.id,
                type: q.question_type.toLowerCase() === "mcq"
                    ? "Multiple Choice"
                    : "Essay Question",
                marks: q.marks,
                questionNumber: index + 1,
                totalQuestions: rawQuestions.length,
                question: q.question_text,
                options: q.options.map((opt, idx) => ({
                    id: opt.id,
                    label: String.fromCharCode(65 + idx), // A, B, C, D...
                    text: opt.option_text
                })),
                note: q.question_type.toLowerCase() === "essay"
                    ? "Write a detailed answer. This will be manually graded by your instructor."
                    : null
            }));
        }

        // ===========================
        // RENDER UI
        // ===========================
        function renderAllQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = examQuestionsData.map(q => {
                return q.type === 'Multiple Choice'
                    ? renderMCQQuestion(q)
                    : renderEssayQuestion(q);
            }).join("");
        }

        function renderMCQQuestion(question) {
            return `
                <div class="question-card-student">
                    <div class="question-header-student">
                        <div class="question-type-badge mcq-badge">
                            <span class="question-number-circle">${question.questionNumber}</span>
                            <span>${question.type}</span>
                        </div>
                        <span class="question-marks">${question.marks} marks</span>
                        <span class="question-counter">Question ${question.questionNumber} of ${question.totalQuestions}</span>
                    </div>

                    <div class="question-content-student">
                        <h3 class="question-text-student">${question.question}</h3>

                        <div class="options-list-student">
                            ${renderMCQOptions(question)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMCQOptions(question) {
            return question.options.map(opt => `
                <label class="option-student ${isOptionSelected(question.id, opt.id) ? 'selected' : ''}">
                    <input
                        type="radio"
                        name="question${question.id}"
                        value="${opt.id}"
                        onchange="handleMCQSelection(${question.id}, ${opt.id})"
                        ${isOptionSelected(question.id, opt.id) ? 'checked' : ''}
                    >
                    <span class="option-radio-custom"></span>
                    <span class="option-label">${opt.label}.</span>
                    <span class="option-text">${opt.text}</span>
                </label>
            `).join("");
        }

        function renderEssayQuestion(question) {
            return `
                <div class="question-card-student">
                    <div class="question-header-student">
                        <div class="question-type-badge essay-badge">
                            <span class="question-number-circle">${question.questionNumber}</span>
                            <span>${question.type}</span>
                        </div>
                        <span class="question-marks">${question.marks} marks</span>
                        <span class="question-counter">Question ${question.questionNumber} of ${question.totalQuestions}</span>
                    </div>

                    <div class="question-content-student">
                        <h3 class="question-text-student">${question.question}</h3>
                        <textarea 
                            class="essay-textarea" 
                            rows="10"
                            placeholder="Type your answer here..."
                            oninput="handleEssayInput(${question.id}, this.value)"
                        >${selectedAnswers[question.id] || ''}</textarea>
                        <p class="essay-note">${question.note}</p>
                    </div>
                </div>
            `;
        }

        // ===========================
        // ANSWER HANDLING
        // ===========================
        function handleMCQSelection(questionId, optionId) {
            if (examHasEnded) {
                alert("Time is up! You cannot change answers anymore.");
                return;
            }
            selectedAnswers[questionId] = optionId;
            updateProgressDisplay();
            renderAllQuestions();
        }

        function handleEssayInput(questionId, value) {
            if (examHasEnded) {
                alert("Time is up! You cannot change answers anymore.");
                return;
            }
            if (value.trim()) {
                selectedAnswers[questionId] = value;
            } else {
                delete selectedAnswers[questionId];
            }
            updateProgressDisplay();
        }

        function isOptionSelected(questionId, optionId) {
            return selectedAnswers[questionId] == optionId;
        }

        // ===========================
        // PROGRESS TRACKING
        // ===========================
        function updateProgressDisplay() {
            const answered = Object.keys(selectedAnswers).length;
            const total = examQuestionsData.length;
            document.getElementById('examProgressText').textContent = `${answered}/${total}`;
        }

        function getUnansweredCount() {
            const total = examQuestionsData.length;
            const answered = Object.keys(selectedAnswers).length;
            return total - answered;
        }

        // ===========================
        // SUBMISSION
        // ===========================
        function handleSubmitClick() {
            if (examHasEnded) {
                alert("Time is up! The exam has ended and submissions are no longer accepted.");
                return;
            }

            if (isSubmitting) {
                alert("Submission in progress. Please wait...");
                return;
            }

            const unanswered = getUnansweredCount();

            if (unanswered > 0) {
                const confirmMsg = `You have ${unanswered} unanswered question(s). Do you still want to submit?`;
                if (!confirm(confirmMsg)) {
                    return;
                }
            }

            if (confirm("Are you sure you want to submit your exam?")) {
                submitExamToBackend();
            }
        }

        async function submitExamToBackend() {
            isSubmitting = true;
            disableSubmitButtons();

            try {
                // Prepare submission data
                const submissionData = prepareSubmissionData();

                // Send to backend
                const response = await axios.post('/take-exam/submit', submissionData);

                // Handle response
                handleSubmissionResponse(response.data);

            } catch (error) {
                console.error("Submission error:", error);
                handleSubmissionError(error);

                // Re-enable buttons if submission failed (unless time is up)
                if (!examHasEnded) {
                    isSubmitting = false;
                    enableSubmitButtons();
                }
            }
        }

        function prepareSubmissionData() {
            const answers = Object.entries(selectedAnswers).map(([questionId, answer]) => ({
                question_id: parseInt(questionId),
                answer: answer
            }));

            return {
                exam_code: currentExamCode,
                user_id: currentUserId,
                answers: answers
            };
        }

        function handleSubmissionResponse(data) {
            clearInterval(timerInterval);

            let message = data.message;

            alert(message);

            // Redirect to exam list or results page
            window.location.href = "/studentSubmissionList";
        }

        function handleSubmissionError(error) {
            if (error.response) {
                // Show specific error message from backend
                const errorMsg = error.response.data.detail || "Submission failed";
                alert(errorMsg);
            } else {
                alert("Submission failed. Please check your connection and try again.");
            }
        }

        // ===========================
        // TIMER
        // ===========================
        async function loadExamDuration(examCode) {
            try {
                const res = await axios.get(`/take-exam/duration/${examCode}`);
                const data = res.data;
                startExamTimer(data.remaining_seconds);

            } catch (error) {
                console.error("Error loading exam duration:", error);
                alert("Failed to load exam timer.");
            }
        }

        function startExamTimer(remainingSeconds) {
            const timerDisplay = document.getElementById("examTimer");

            // Change timer color when less than 5 minutes
            function updateTimerStyle(seconds) {
                if (seconds <= 300 && seconds > 60) { // 5 minutes
                    timerDisplay.style.color = '#ff9800'; // Orange
                } else if (seconds <= 60) { // 1 minute
                    timerDisplay.style.color = '#dc3545'; // Red
                    timerDisplay.style.fontWeight = 'bold';
                }
            }

            timerInterval = setInterval(() => {
                const timeStr = formatTime(remainingSeconds);
                timerDisplay.textContent = `Time Left: ${timeStr}`;

                updateTimerStyle(remainingSeconds);

                remainingSeconds--;

                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    handleTimeUp(); // Handle time up scenario
                }
            }, 1000);
        }

        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ===========================
        // TIME UP HANDLING - NO AUTO SUBMIT
        // ===========================
        function handleTimeUp() {
            examHasEnded = true;

            // Disable all inputs
            disableAllInputs();

            // Disable submit buttons
            disableSubmitButtons();

            // Show time's up modal
            showTimeUpModal();
        }

        function disableAllInputs() {
            // Disable all radio buttons
            document.querySelectorAll('input[type="radio"]').forEach(input => {
                input.disabled = true;
            });

            // Disable all textareas
            document.querySelectorAll('textarea').forEach(textarea => {
                textarea.disabled = true;
                textarea.style.backgroundColor = '#f5f5f5';
            });
        }

        function disableSubmitButtons() {
            const headerBtn = document.getElementById('submitBtnHeader');
            const footerBtn = document.getElementById('submitBtnFooter');

            if (headerBtn) {
                headerBtn.disabled = true;
                headerBtn.style.opacity = '0.5';
                headerBtn.style.cursor = 'not-allowed';
            }

            if (footerBtn) {
                footerBtn.disabled = true;
                footerBtn.style.opacity = '0.5';
                footerBtn.style.cursor = 'not-allowed';
            }
        }

        function enableSubmitButtons() {
            const headerBtn = document.getElementById('submitBtnHeader');
            const footerBtn = document.getElementById('submitBtnFooter');

            if (headerBtn) {
                headerBtn.disabled = false;
                headerBtn.style.opacity = '1';
                headerBtn.style.cursor = 'pointer';
            }

            if (footerBtn) {
                footerBtn.disabled = false;
                footerBtn.style.opacity = '1';
                footerBtn.style.cursor = 'pointer';
            }
        }

        function showTimeUpModal() {
            const modal = document.getElementById('timeUpModal');
            modal.style.display = 'flex';
        }

        // ===========================
        // PAGE LOAD
        // ===========================
        initializeExam();

    </script>
</body>

</html>